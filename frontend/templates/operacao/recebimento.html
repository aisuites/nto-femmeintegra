{% extends "base.html" %}
{% load static %}
{% block title %}Recebimento ‚Äì FEMME Integra{% endblock %}

{% block head_extra %}
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/recebimento.css' %}">
{% endblock %}

{% block content %}
{% block content %}
<div class="page">

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo">F</div>
        <div class="brand-text">
          <div class="name">FEMME Integra</div>
          <div class="tagline">Gest√£o de requisi√ß√µes & amostras</div>
        </div>
      </div>

      <div class="header-right">
        <span class="header-badge-env">Ambiente interno</span>
        <div class="user-info">
          <div class="user-avatar">L</div>
          <div>
            <div style="font-weight:600;">Luciana</div>
            <div style="font-size:11px; color:var(--femme-gray);">Marketing / Projetos FEMME</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- LAYOUT PRINCIPAL -->
  <div class="shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="sidebar-section-title">Navega√ß√£o</div>
        <nav class="sidebar-nav">
          <a class="sidebar-link {% if active_page == 'dashboard' %}active{% endif %}" href="{% url 'core:dashboard' %}">
            <span class="icon">üè†</span>
            <span>Dashboard</span>
          </a>
          <div class="sidebar-link">
            <span class="icon">‚öô</span>
            <span>Operacional</span>
          </div>
          <a class="sidebar-link subitem {% if active_page == 'recebimento' %}active{% endif %}" href="{% url 'operacao:recebimento' %}">
            <span class="icon">‚¨á</span>
            <span>Recebimento</span>
          </a>
          <div class="sidebar-link subitem">
            <span class="icon">ü©∫</span>
            <span>Triagem</span>
          </div>
          <div class="sidebar-link subitem">
            <span class="icon">‚è±</span>
            <span>Pend√™ncias</span>
          </div>

          <div class="sidebar-divider"></div>

          <div class="sidebar-link">
            <span class="icon">üìä</span>
            <span>Gest√£o</span>
          </div>

          <div class="sidebar-link">
            <span class="icon">üí¨</span>
            <span>Atendimento</span>
          </div>
        </nav>
      </div>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main">

      <!-- BLOCO PRINCIPAL: FORM DE RECEBIMENTO -->
      <section class="recebimento-wrapper">
        <div class="recebimento-header">
          <div class="section-kicker">Recebimento</div>
          <!--<div class="section-title">Registrar novo kit de requisi√ß√µes</div>-->
          <!--<div class="section-subtitle">
            Informe a unidade de origem, portador/representante, quantidade de amostras e bipagem
            da requisi√ß√£o principal. As requisi√ß√µes bipadas ser√£o listadas abaixo.
          </div>-->
        </div>

        <!-- BLOCO 1 ‚Äì UNIDADE -->
        <div class="form-block">
          <div class="block-title">1. Unidade</div>
          <div class="units-grid">
            {% if unidades %}
              {% for unidade in unidades %}
                <label class="unit-card {% if unidade_padrao and unidade.id == unidade_padrao.id %}unit-card--selected{% endif %}">
                  <input
                      type="radio"
                      name="unidade_origem"
                      value="{{ unidade.id }}"
                      data-unidade-nome="{{ unidade.nome }}"
                      data-unidade-codigo="{{ unidade.codigo }}"
                      {% if unidade_padrao and unidade.id == unidade_padrao.id %}checked{% endif %}
                  />
                  <span>{{ unidade.nome }}</span>
                </label>
              {% endfor %}
            {% else %}
              <p class="info-inline">Cadastre unidades para habilitar esta etapa.</p>
            {% endif %}
          </div>
          <input type="hidden" id="unidadeSelecionada" name="unidade_id" value="{{ unidade_padrao.id|default_if_none:'' }}">
        </div>

        <!-- BLOCO 2 ‚Äì PORTADOR / REPRESENTANTE E ORIGEM -->
        <div class="form-block">
          <div class="block-title">2. Portador / Representante & origem</div>

          <div class="fields-grid">
            <div class="field">
              <div class="field-label-row">
                <label for="campo_portador">Portador / Representante</label>
              </div>
              <!-- No Django este select vir√° da tabela de portadores/representantes -->
              <select id="campo_portador">
                <option value="">Selecione...</option>
                {% for portador in portadores %}
                  <option
                      value="{{ portador.id }}"
                      data-unidade-id="{{ portador.unidade_id }}"
                      data-origem="{{ portador.origem.descricao|default_if_none:'' }}"
                      data-tipo="{{ portador.get_tipo_display }}"
                  >
                    {{ portador.nome }}
                  </option>
                {% empty %}
                  <option value="" disabled>Nenhum portador cadastrado</option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <div class="field-label-row">
                <label for="campo_origem">Origem</label>
              </div>
              <input type="text" id="campo_origem" readonly
                     placeholder="Ser√° preenchido automaticamente" />
            </div>

            <div class="field">
              <div class="field-label-row">
                <label for="campo_qtd_amostras">Qtd. de amostras</label>
              </div>
              <div class="qty-control">
                <button class="qty-btn" type="button" id="btn_qty_menos">‚àí</button>
                <input class="qty-input" id="campo_qtd_amostras" type="number" min="1" value="1" />
                <button class="qty-btn" type="button" id="btn_qty_mais">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- BLOCO 3 ‚Äì BIPAGEM DA REQUISI√á√ÉO -->
        <div class="form-block">
          <div class="block-title">3. Bipagem da requisi√ß√£o</div>

          <div class="field">
            <div class="field-label-row">
              <label for="campo_cod_barras">C√≥digo de barras da requisi√ß√£o</label>
            </div>

            <div class="barcode-row">
              <div style="position:absolute; width:0; height:0; overflow:hidden;" aria-hidden="true">
                <input type="hidden" id="csrf_token_input" value="{{ csrf_token }}">
                {% csrf_token %}
              </div>
              <input type="text" id="campo_cod_barras" placeholder="Aproxime a pistola ou digite o c√≥digo" />
              <button class="btn btn-primary" type="button" id="btn_localizar" data-url="{% url 'operacao:recebimento-localizar' %}">
                üîç Localizar
              </button>
            </div>

            <div class="info-inline">
              ‚Ä¢ A pistola de c√≥digo de barras deve disparar automaticamente a a√ß√£o de localizar.
              Se necess√°rio, o usu√°rio pode digitar o c√≥digo manualmente e clicar em <strong>Localizar</strong>.
            </div>

            <div class="alert" id="recebimento_alert" role="alert" aria-live="assertive">
              <strong>Ops!</strong>
              <span id="alert_message"></span>
            </div>
          </div>
        </div>

        <!-- LISTA DE REQUISI√á√ïES BIPADAS -->
        <div class="kit-table-wrapper">
          <div class="kit-table-header">
            <div>
              <strong>Requisi√ß√µes bipadas neste kit:</strong> {{ requisicoes_recent|length }} registros
            </div>
            <div>
              Kit em edi√ß√£o ¬∑ n√£o esque√ßa de salvar ao finalizar
            </div>
          </div>

          {% if requisicoes_recent %}
            <table>
              <thead>
              <tr>
                <th>C√≥d. Req.</th>
                <th>C√≥d. Barras</th>
                <th>Unidade</th>
                <th>Origem</th>
                <th>Data/Hora bipagem</th>
              </tr>
              </thead>
              <tbody>
              {% for requisicao in requisicoes_recent %}
                <tr>
                  <td>{{ requisicao.cod_req }}</td>
                  <td>{{ requisicao.cod_barras_req }}</td>
                  <td>{{ requisicao.unidade.nome }}</td>
                  <td>{{ requisicao.origem.descricao|default:"-" }}</td>
                  <td>{{ requisicao.created_at|date:"d/m/Y ¬∑ H:i" }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div style="padding:16px; font-size:12px; color:var(--femme-gray);">
              Ainda n√£o h√° requisi√ß√µes bipadas. Utilize o formul√°rio acima para iniciar um kit.
            </div>
          {% endif %}
        </div>

        <!-- A√á√ïES FINAIS DO KIT -->
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:6px; font-size:12px;">
          <button class="btn btn-ghost" type="button">Cancelar kit</button>
          <button class="btn btn-outline" type="button">Salvar rascunho</button>
          <button class="btn btn-primary" type="button" id="btn_finalizar_recebimento">‚úÖ Finalizar recebimento</button>
        </div>
      </section>
    </main>
    <!-- MODAL BIPAGEM -->
    <div class="modal-overlay" id="modal_bipagem" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal_title">
        <div class="modal-header">
          <div class="modal-title" id="modal_title">
            <div class="modal-badge-icon">‚ö†</div>
            <div class="modal-title-text">
              <span class="label">Aviso de recebimento</span>
              <h2>Bipagem das amostras do kit</h2>
            </div>
          </div>
          <button class="modal-close-icon" type="button" id="modal_close" aria-label="Fechar modal">√ó</button>
        </div>

        <div class="modal-body">
          <div class="modal-main-text">
            PARA DAR ANDAMENTO BIPE O(S) C√ìDIGO(S) DE BARRA(S) DA(S) AMOSTRA(S).
          </div>

          <div class="modal-meta">
            Requisi√ß√£o: <strong id="modal_cod_req">‚Äî</strong> ¬∑
            C√≥digo de barras da requisi√ß√£o: <strong id="modal_cod_barras_req">‚Äî</strong><br />
            Qtd. de amostras informada: <strong id="modal_qtd_amostras">0</strong>
            &nbsp;‚Äì&nbsp; bipar o mesmo n√∫mero de c√≥digos abaixo.
          </div>

          <div class="field">
            <div class="field-label-row">
              <label>C√≥digos de barras das amostras</label>
              <span class="helper">Um c√≥digo por amostra</span>
            </div>

            <div class="samples-list" id="modal_samples_list"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline" type="button" id="modal_btn_cancelar">Cancelar</button>
          <button class="btn btn-primary" type="button" id="modal_btn_validar">Validar</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}

<script src="{% static 'js/recebimento.js' %}"></script>
{% endblock %}
