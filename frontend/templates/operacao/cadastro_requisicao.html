{% extends "base_app.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cadastro_requisicao.css' %}" />
{% endblock %}

{% block main_content %}
<!-- SE√á√ÉO BIPAGEM (CONTE√öDO FIXO) -->
<section class="card">
  <div class="barcode-section">
    <div>
      <div class="section-kicker">Cadastro</div>
      <div class="section-title">Localizar requisi√ß√£o para cadastro</div>
      <div class="section-subtitle">
        Bipe o c√≥digo de barras da requisi√ß√£o ou digite manualmente para iniciar o cadastro.
      </div>
    </div>

    <div class="barcode-row">
      <input 
        type="text" 
        id="input-cod-barras-cadastro" 
        placeholder="Bipe ou digite o c√≥digo de barras da requisi√ß√£o"
        autocomplete="off"
      />
      <button class="btn btn-primary" type="button" id="btn-localizar-cadastro">
        üîç Localizar
      </button>
    </div>

    <div class="info-inline">
      ‚Ä¢ Apenas requisi√ß√µes com status CADASTRADA podem ser processadas nesta p√°gina.
    </div>
  </div>
</section>

<!-- √ÅREA DIN√ÇMICA - CADASTRO DA REQUISI√á√ÉO (INICIALMENTE OCULTA) -->
<section class="card" id="cadastro-container" style="display: none;">
  <div class="cadastro-step">

    <!-- HEADER -->
    <div class="step-header">
      <div>
        <span class="step-badge step-badge-cadastro">Cadastro Requisi√ß√£o</span>
      </div>
      <div style="font-size:11px; color:var(--femme-gray);">
        Requisi√ß√£o <strong id="req-codigo-display">#---</strong> ¬∑ C√≥d. barras <strong id="req-barras-display">---</strong>
      </div>
    </div>

    <!-- UNIDADE EM DESTAQUE -->
    <div class="unidade-destaque">
      <span class="unidade-label">Unidade:</span>
      <span class="unidade-nome" id="unidade-nome-display">---</span>
    </div>

    <div class="divider"></div>

    <!-- BLOCO DADOS DO PACIENTE -->
    <div class="section-title-sm">Dados do Paciente</div>
    
    <!-- Box CPF + A√ß√µes -->
    <div class="form-box">
      <div class="cpf-actions-row">
        <div class="field field-cpf">
          <label class="label-strong">CPF Paciente</label>
          <input type="text" id="cpf-paciente" placeholder="000.000.000-00" maxlength="14" />
        </div>
        <button class="btn btn-outline" type="button" id="btn-cpf-korus" title="Consultar CPF na base FEMME">CPF Korus</button>
        <button class="btn btn-muted" type="button" id="btn-rodar-ocr" disabled title="API em desenvolvimento">Rodar OCR</button>
        <button class="btn btn-outline" type="button" id="btn-cpf-receita" title="Consultar CPF na Receita Federal">CPF Receita</button>
        <label class="check-inline">
          <input type="checkbox" id="check-problema-cpf" />
          Problema com CPF
        </label>
        <button class="btn btn-outline" type="button" id="btn-ver-imagem-requisicao" title="Ver imagem digitalizada da requisi√ß√£o">Ver imagem requisi√ß√£o</button>
      </div>
    </div>

    <!-- √ÅREA DE ALERTA CPF -->
    <div class="alert alert-validacao" id="cadastro_alert_cpf" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="cadastro_alert_cpf_message"></span>
    </div>

    <!-- Box Dados do Paciente -->
    <div class="form-box">
      <div class="field field-full">
        <label class="label-strong">Nome paciente</label>
        <input type="text" id="nome-paciente" placeholder="Nome do paciente" />
      </div>
      
      <div class="form-row four-cols">
        <div class="field">
          <label class="label-strong">DUM (Data √öltima Menstrua√ß√£o)</label>
          <input type="date" id="data-dum" />
        </div>
        <div class="field">
          <label class="label-strong">Data de Nascimento</label>
          <input type="date" id="data-nascimento" />
        </div>
        <div class="field">
          <label class="label-strong">Email</label>
          <input type="email" id="email-paciente" placeholder="email@exemplo.com" />
        </div>
        <div class="field">
          <label class="label-strong">Telefone</label>
          <input type="text" id="telefone-paciente" placeholder="(00) 00000-0000" maxlength="15" />
        </div>
      </div>

      <div class="form-row sexo-row">
        <div class="field field-sexo">
          <label class="label-strong">Sexo</label>
          <select id="sexo-paciente">
            <option value="">Selecione...</option>
            <option value="F">Feminino</option>
            <option value="M">Masculino</option>
          </select>
        </div>
        <label class="check-inline check-a-confirmar">
          <input type="checkbox" id="check-sexo-a-confirmar" />
          A confirmar
        </label>
      </div>
    </div>

    <div class="divider"></div>

    <!-- BLOCO DADOS M√âDICO -->
    <div class="section-title-sm">Dados do M√©dico</div>

    <!-- Box CRM + A√ß√µes -->
    <div class="form-box">
      <div class="medico-actions-row">
        <div class="field field-crm">
          <label class="label-strong">CRM</label>
          <input type="text" id="crm-medico" placeholder="N√∫mero do CRM" pattern="[0-9]*" inputmode="numeric" />
        </div>
        <div class="field field-uf">
          <label class="label-strong">UF-CRM</label>
          <div class="custom-dropdown-wrapper" id="uf-crm-wrapper">
            <input type="text" id="uf-crm" placeholder="UF" maxlength="2" style="text-transform: uppercase;" autocomplete="off" />
            <div class="custom-dropdown-list" id="uf-crm-dropdown">
              <div class="custom-dropdown-item" data-value="AC">AC</div>
              <div class="custom-dropdown-item" data-value="AL">AL</div>
              <div class="custom-dropdown-item" data-value="AM">AM</div>
              <div class="custom-dropdown-item" data-value="AP">AP</div>
              <div class="custom-dropdown-item" data-value="BA">BA</div>
              <div class="custom-dropdown-item" data-value="CE">CE</div>
              <div class="custom-dropdown-item" data-value="DF">DF</div>
              <div class="custom-dropdown-item" data-value="ES">ES</div>
              <div class="custom-dropdown-item" data-value="GO">GO</div>
              <div class="custom-dropdown-item" data-value="MA">MA</div>
              <div class="custom-dropdown-item" data-value="MG">MG</div>
              <div class="custom-dropdown-item" data-value="MS">MS</div>
              <div class="custom-dropdown-item" data-value="MT">MT</div>
              <div class="custom-dropdown-item" data-value="PA">PA</div>
              <div class="custom-dropdown-item" data-value="PB">PB</div>
              <div class="custom-dropdown-item" data-value="PE">PE</div>
              <div class="custom-dropdown-item" data-value="PI">PI</div>
              <div class="custom-dropdown-item" data-value="PR">PR</div>
              <div class="custom-dropdown-item" data-value="RJ">RJ</div>
              <div class="custom-dropdown-item" data-value="RN">RN</div>
              <div class="custom-dropdown-item" data-value="RO">RO</div>
              <div class="custom-dropdown-item" data-value="RR">RR</div>
              <div class="custom-dropdown-item" data-value="RS">RS</div>
              <div class="custom-dropdown-item" data-value="SC">SC</div>
              <div class="custom-dropdown-item" data-value="SE">SE</div>
              <div class="custom-dropdown-item" data-value="SP">SP</div>
              <div class="custom-dropdown-item" data-value="TO">TO</div>
            </div>
          </div>
        </div>
        <button class="btn btn-outline btn-valida" type="button" id="btn-valida-medico" title="Validar m√©dico na API FEMME">Valida M√©dico</button>
        <label class="check-inline">
          <input type="checkbox" id="check-problema-medico" />
          Dados m√©dico com problema
        </label>
      </div>
    </div>

    <!-- √ÅREA DE ALERTA M√âDICO -->
    <div class="alert alert-validacao" id="cadastro_alert_medico" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="cadastro_alert_medico_message"></span>
    </div>

    <!-- Box Dados do M√©dico (readonly) -->
    <div class="form-box">
      <div class="field field-full">
        <label class="label-strong">Nome do m√©dico</label>
        <input type="text" id="nome-medico" readonly placeholder="Preenchido via API Valida M√©dico" />
      </div>
      <div class="form-row two-cols">
        <div class="field">
          <label class="label-strong">Endere√ßo m√©dico</label>
          <input type="text" id="endereco-medico" readonly placeholder="Preenchido via API Valida M√©dico" />
        </div>
        <div class="field">
          <label class="label-strong">Destino</label>
          <input type="text" id="destino-medico" readonly placeholder="Preenchido via API Valida M√©dico" />
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- BLOCO EXAMES E ATENDIMENTO -->
    <div class="section-title-sm">Exames e Atendimento</div>

    <!-- Box Tipo de Atendimento -->
    <div class="form-box">
      <div class="exames-actions-row">
        <div class="field field-tipo-atendimento">
          <label class="label-strong">Tipo de Atendimento</label>
          <select id="select-tipo-atendimento">
            <option value="">Selecione o tipo...</option>
            {% for tipo in tipos_atendimento %}
            <option value="{{ tipo.id }}" data-codigo="{{ tipo.codigo }}">{{ tipo.descricao }}</option>
            {% endfor %}
          </select>
        </div>
        <button class="btn btn-outline" type="button" id="btn-adicionar-exame" title="Adicionar exame">
          + Adicionar
        </button>
      </div>
    </div>

    <!-- GRID DE EXAMES -->
    <div class="exames-grid" id="exames-grid">
      <div class="exames-grid-header">
        <span>EXAMES SELECIONADOS</span>
        <span>TIPO ATENDIMENTO</span>
      </div>
      <div class="exames-grid-body" id="exames-grid-body">
        <!-- Exames ser√£o carregados dinamicamente via JS -->
        <div class="exames-empty" id="exames-empty">
          Nenhum exame adicionado. Selecione o tipo de atendimento e clique em "+ Adicionar".
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- BLOCO UPLOAD IMAGEM -->
    <div class="row">
      <div class="field">
        <span class="label-strong">Upload imagens (n√£o obrigat√≥rio)</span>
        <div class="scanner-box">
          <div class="scanner-row">
            <button class="btn btn-outline" type="button" id="btn-carregar-imagem">üìÅ Carregar Imagem</button>
            <input type="file" id="input-upload-imagem" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none;" />
            <!-- Arquivos aparecer√£o aqui dinamicamente -->
            <div id="upload-files-container"></div>
          </div>
          <div class="info-inline" id="info-formatos-aceitos">
            Selecione um ou mais arquivos. Formatos aceitos: PDF, JPEG, JPG ou PNG.
          </div>
        </div>
      </div>
    </div>

    <!-- √ÅREA DE ALERTA GERAL -->
    <div class="alert alert-validacao" id="cadastro_alert_geral" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="cadastro_alert_geral_message"></span>
    </div>

    <!-- A√á√ïES -->
    <div class="step-actions">
      <button class="btn btn-outline" type="button" id="btn-cancelar-cadastro">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-autorizar">AUTORIZAR</button>
    </div>

  </div>
</section>

<!-- MODAL VISUALIZAR IMAGEM -->
<div class="modal-overlay" id="modal-ver-imagem" style="display: none;">
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h3>üìÑ Imagem da Requisi√ß√£o</h3>
      <button class="modal-close" type="button" id="btn-fechar-modal-imagem">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="imagem-requisicao-container">
        <p class="text-muted">Carregando imagem...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btn-fechar-modal-imagem-footer">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAR EXCLUS√ÉO DE EXAME -->
<div class="modal-overlay" id="modal-excluir-exame" style="display: none;">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Excluir Exame</h3>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir este exame?</p>
      <p class="text-muted" id="exame-excluir-info">Exame: ---</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btn-cancelar-excluir-exame">Cancelar</button>
      <button class="btn btn-danger" type="button" id="btn-confirmar-excluir-exame">Excluir</button>
    </div>
  </div>
</div>

<!-- MODAL PROBLEMA COM M√âDICO -->
<div class="modal-overlay" id="modal-problema-medico" style="display: none;">
  <div class="modal-content modal-md">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Problema na Valida√ß√£o do M√©dico</h3>
      <button class="modal-close" type="button" id="btn-fechar-modal-medico">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="modal-medico-mensagem" class="alert alert-warning" style="margin-bottom: 1rem;">
        <!-- Mensagem din√¢mica -->
      </div>
      <div id="modal-medico-info" style="margin-bottom: 1rem;">
        <!-- Informa√ß√µes do m√©dico se encontrado -->
      </div>
      <p class="text-muted">O que deseja fazer?</p>
    </div>
    <div class="modal-footer" style="flex-direction: column; gap: 0.5rem;">
      <button class="btn btn-warning btn-block" type="button" id="btn-registrar-pendencia-medico">
        üìã Registrar Pend√™ncia
      </button>
      <button class="btn btn-outline btn-block" type="button" id="btn-cancelar-modal-medico">
        Cancelar e Corrigir CRM
      </button>
    </div>
  </div>
</div>

<!-- Modal de Email Reutiliz√°vel -->
{% include 'includes/modal_email.html' %}

<!-- Hidden CSRF token -->
{% csrf_token %}

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/components/modal_email.js' %}"></script>
<script src="{% static 'js/cadastro_requisicao.js' %}"></script>
{% endblock %}
