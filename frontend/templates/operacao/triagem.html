{% extends "base_app.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/triagem.css' %}" />
<link rel="stylesheet" href="{% static 'css/scanner-modal.css' %}" />
<link rel="stylesheet" href="{% static 'css/dynamsoft_toolbar_only.css' %}" />
{% endblock %}

{% block main_content %}
<!-- SEÃ‡ÃƒO BIPAGEM (CONTEÃšDO FIXO) -->
<section class="card">
  <div class="barcode-section">
    <div>
      <div class="section-kicker">Triagem</div>
      <div class="section-title">Localizar requisiÃ§Ã£o para triagem</div>
      <div class="section-subtitle">
        Bipe o cÃ³digo de barras da requisiÃ§Ã£o ou digite manualmente para iniciar a etapa de triagem.
      </div>
    </div>

    <div class="barcode-row">
      <input 
        type="text" 
        id="input-cod-barras-triagem" 
        placeholder="Bipe ou digite o cÃ³digo de barras da requisiÃ§Ã£o"
        autocomplete="off"
      />
      <button class="btn btn-primary" type="button" id="btn-localizar-triagem">
        ğŸ” Localizar
      </button>
    </div>

    <div class="info-inline">
      â€¢ ApÃ³s localizar, a etapa da triagem serÃ¡ carregada abaixo de acordo com o status da requisiÃ§Ã£o.
    </div>
  </div>
</section>

<!-- ÃREA DINÃ‚MICA - ETAPA 1 DA TRIAGEM (INICIALMENTE OCULTA) -->
<section class="card" id="triagem-step-container" style="display: none;">
  <div class="triagem-step">

    <div class="step-header">
      <div>
        <span class="step-badge">Etapa 1 Â· ConferÃªncia de dados e amostras</span>
      </div>
      <div style="font-size:11px; color:var(--femme-gray);">
        RequisiÃ§Ã£o <strong id="req-codigo-display">#---</strong> Â· CÃ³d. barras <strong id="req-barras-display">---</strong>
      </div>
    </div>

    <!-- CAMPOS PRINCIPAIS -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Id da requisiÃ§Ã£o</label>
        <input type="text" id="req-id" readonly />
      </div>

      <div class="field">
        <label>CÃ³digo de barras bipado</label>
        <input type="text" id="req-cod-barras" readonly />
      </div>

      <div class="field">
        <label>Data de recebimento</label>
        <input type="date" id="req-data-recebimento" />
      </div>

      <!-- SCANNER -->
      <div class="field">
        <label>DigitalizaÃ§Ã£o da requisiÃ§Ã£o (Scanner)</label>
        <div class="scanner-box">
          <div class="scanner-row">
            <button class="btn btn-outline" type="button" id="btn-scanner">ğŸ“  SCANNER</button>
            <!-- Arquivos aparecerÃ£o aqui dinamicamente -->
            <div id="scanner-files-container"></div>
          </div>
          <div class="info-inline">
            ObrigatÃ³rio: 1 imagem por requisiÃ§Ã£o. Se necessÃ¡rio, exclua e faÃ§a novo scan.
          </div>
        </div>
      </div>
    </div>

    <!-- DADOS POR AMOSTRA -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Amostra vinculada</label>
        <select id="select-amostra">
          <option value="">Selecione uma amostra...</option>
        </select>
      </div>

      <div></div>

      <!-- DATA COLETA + CHECKBOX -->
      <div class="field">
        <label>Data da coleta</label>
        <input type="date" id="amostra-data-coleta" />
        <label class="checkbox-item" style="margin-top:6px; width:max-content;">
          <input type="checkbox" id="check-data-rasurada" />
          <span>Data rasurada</span>
        </label>
      </div>

      <!-- DATA VALIDADE + CHECKBOX -->
      <div class="field">
        <label>Data de validade</label>
        <input type="date" id="amostra-data-validade" />
        <label class="checkbox-item" style="margin-top:6px; width:max-content;">
          <input type="checkbox" id="check-sem-validade" />
          <span>Sem data de validade</span>
        </label>
      </div>
    </div>

    <!-- CHECKBOXES FINAIS EM 2x2 -->
    <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; margin-top:12px;">

      <!-- Linha 1 -->
      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-sem-identificacao" />
          <span>Amostra sem identificaÃ§Ã£o â€“ biÃ³psia / swab</span>
        </label>
      </div>

      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-armazenamento-inadequado" />
          <span>Armazenamento inadequado</span>
        </label>
        <select class="inline-dropdown" id="select-motivo-armazenamento" disabled>
          <option value="">Selecione o motivoâ€¦</option>
          <option value="temperatura">Temperatura fora do padrÃ£o</option>
          <option value="transporte">Transporte inadequado</option>
          <option value="tempo">Tempo de guarda excedido</option>
        </select>
      </div>

      <!-- Linha 2 -->
      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-frasco-trocado" />
          <span>Frasco trocado â€“ tipo de coletor</span>
        </label>
      </div>

      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-material-nao-analisado" />
          <span>Tipo de material nÃ£o analisado pelo FEMME</span>
        </label>
      </div>

    </div>

    <!-- SEÃ‡ÃƒO DE ARQUIVOS DIGITALIZADOS -->
    <div class="scanner-files-section" style="margin-top: 24px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
        <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--femme-dark);">
          ğŸ“„ Documentos digitalizados
        </h3>
        <button class="btn btn-outline-sm" type="button" id="btn-scanner">
          ğŸ“· Digitalizar
        </button>
      </div>
      <div id="scanner-files-container" style="min-height: 40px;">
        <p style="color: var(--femme-gray); font-size: 13px; margin: 0;">
          Nenhum documento digitalizado ainda.
        </p>
      </div>
    </div>

    <!-- AÃ‡Ã•ES -->
    <div class="step-actions">
      <button class="btn btn-outline" type="button" id="btn-cancelar-triagem">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-seguir-triagem">SEGUIR</button>
    </div>

  </div>
</section>

<!-- MODAL DE SCANNER - LAYOUT ELEGANTE FEMME -->
<div class="scanner-overlay" id="modal-scanner-teste" style="display: none;">
  <div class="scanner-modal">
    <!-- Header -->
    <div class="scanner-modal-header">
      <div class="scanner-modal-title">
        <h2>ğŸ“„ Digitalizar requisiÃ§Ã£o</h2>
        <span>Use o scanner conectado para capturar o papel da requisiÃ§Ã£o.</span>
      </div>
      <button class="scanner-modal-close" type="button" id="btn-fechar-modal" aria-label="Fechar modal">âœ•</button>
    </div>
    
    <!-- Body -->
    <div class="scanner-modal-body">
      <!-- Viewer + toolbar -->
      <div class="scanner-viewer">
        <!-- Toolbar Elegante -->
        <div class="scanner-toolbar">
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Remover pÃ¡gina atual" id="btn-remove-current" aria-label="Remover pÃ¡gina atual">ğŸ—‘ï¸</button>
            <button type="button" class="scanner-tool-btn" title="Remover todas as pÃ¡ginas" id="btn-remove-all" aria-label="Remover todas as pÃ¡ginas">ğŸ—‘ï¸ğŸ—‘ï¸</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Diminuir zoom" id="btn-zoom-out" aria-label="Diminuir zoom">â–</button>
            <span class="scanner-page-info">
              <input type="text" id="DW_spanZoom" readonly style="width:40px;border:none;background:transparent;text-align:center;font-size:11px;color:#34343a;">
            </span>
            <button type="button" class="scanner-tool-btn" title="Aumentar zoom" id="btn-zoom-in" aria-label="Aumentar zoom">â•</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Girar Ã  esquerda" id="btn-rotate" aria-label="Girar imagem Ã  esquerda">â†º</button>
            <button type="button" class="scanner-tool-btn" title="Tamanho original" id="btn-original-size" aria-label="Restaurar tamanho original">âŠŸ</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Ferramenta de mÃ£o para mover imagem" id="btn-hand" aria-label="Ativar ferramenta de mÃ£o">ğŸ–ï¸</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <span class="scanner-page-info">
            PÃ¡g. <input type="text" id="DW_CurrentImage" readonly style="width:24px;border:none;background:transparent;text-align:center;"> / 
            <input type="text" id="DW_TotalImage" readonly style="width:24px;border:none;background:transparent;text-align:center;">
          </span>
        </div>
        
        <!-- Viewer do Dynamsoft -->
        <div id="dwtcontrolContainer" style="width:100%;min-height:360px;border-radius:10px;background:#fff;"></div>
      </div>
      
      <!-- Config / aÃ§Ãµes -->
      <div class="scanner-config">
        <div class="scanner-config-title">ConfiguraÃ§Ãµes do scanner</div>
        
        <div>
          <label for="scanner-select">Scanner conectado</label>
          <select id="scanner-select">
            <option>Carregando scanners...</option>
          </select>
        </div>
        
        <div style="margin-top:10px;">
          <label for="resolution-select">ResoluÃ§Ã£o (DPI)</label>
          <select id="resolution-select">
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200" selected>200</option>
            <option value="300">300</option>
          </select>
        </div>
        
        <div class="scanner-actions">
          <button type="button" class="btn-pill-primary" id="btn-carregar-imagem">ğŸ“ Carregar Imagem</button>
          <button type="button" class="btn-pill-primary" id="btn-digitalizar">ğŸ“· Digitalizar</button>
          <button type="button" class="btn-pill-primary" id="btn-enviar-aws">ğŸ“¤ Enviar</button>
          <button type="button" class="btn-pill-ghost" id="btn-fechar-modal-footer">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- ConfiguraÃ§Ãµes e Ambiente -->
<script src="{% static 'js/config.js' %}"></script>

<!-- MÃ³dulo do Scanner Dynamsoft -->
<script src="{% static 'js/scanner.js' %}"></script>

<script>
// ============================================
// INICIALIZAÃ‡ÃƒO DO SCANNER DYNAMSOFT
// ============================================

// Inicializar mÃ³dulo do scanner com licenÃ§a do Django
DynamosoftScanner.init('{{ dynamsoft_license }}', {% if DEBUG %}true{% else %}false{% endif %});
</script>

<!-- MÃ³dulo da pÃ¡gina de Triagem -->
<script src="{% static 'js/triagem.js' %}"></script>
{% endblock %}

