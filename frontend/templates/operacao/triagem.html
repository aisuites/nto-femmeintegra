{% extends "base_app.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/triagem.css' %}" />
<link rel="stylesheet" href="{% static 'css/scanner-modal.css' %}" />
<link rel="stylesheet" href="{% static 'css/dynamsoft_toolbar_only.css' %}" />
{% endblock %}

{% block main_content %}
<!-- SE√á√ÉO BIPAGEM (CONTE√öDO FIXO) -->
<section class="card">
  <div class="barcode-section">
    <div>
      <div class="section-kicker">Triagem</div>
      <div class="section-title">Localizar requisi√ß√£o para triagem</div>
      <div class="section-subtitle">
        Bipe o c√≥digo de barras da requisi√ß√£o ou digite manualmente para iniciar a etapa de triagem.
      </div>
    </div>

    <div class="barcode-row">
      <input 
        type="text" 
        id="input-cod-barras-triagem" 
        placeholder="Bipe ou digite o c√≥digo de barras da requisi√ß√£o"
        autocomplete="off"
      />
      <button class="btn btn-primary" type="button" id="btn-localizar-triagem">
        üîç Localizar
      </button>
    </div>

    <div class="info-inline">
      ‚Ä¢ Ap√≥s localizar, a etapa da triagem ser√° carregada abaixo de acordo com o status da requisi√ß√£o.
    </div>
  </div>
</section>

<!-- √ÅREA DIN√ÇMICA - ETAPA 1 DA TRIAGEM (INICIALMENTE OCULTA) -->
<section class="card" id="triagem-step-container" style="display: none;">
  <div class="triagem-step">

    <div class="step-header">
      <div>
        <span class="step-badge">Etapa 1 ¬∑ Confer√™ncia de dados e amostras</span>
      </div>
      <div style="font-size:11px; color:var(--femme-gray);">
        Requisi√ß√£o <strong id="req-codigo-display">#---</strong> ¬∑ C√≥d. barras <strong id="req-barras-display">---</strong>
      </div>
    </div>

    <!-- CAMPOS PRINCIPAIS -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Id da requisi√ß√£o</label>
        <input type="text" id="req-id" readonly />
      </div>

      <div class="field">
        <label>C√≥digo de barras bipado</label>
        <input type="text" id="req-cod-barras" readonly />
      </div>

      <div class="field">
        <label>Data de recebimento</label>
        <input type="date" id="req-data-recebimento" readonly />
      </div>

      <!-- SCANNER -->
      <div class="field">
        <label>Digitaliza√ß√£o da requisi√ß√£o (Scanner)</label>
        <div class="scanner-box">
          <div class="scanner-row">
            <button class="btn btn-outline" type="button" id="btn-scanner">üì† SCANNER</button>
            <!-- Arquivos aparecer√£o aqui dinamicamente -->
            <div id="scanner-files-container"></div>
          </div>
          <div class="info-inline">
            Obrigat√≥rio: 1 imagem por requisi√ß√£o. Se necess√°rio, exclua e fa√ßa novo scan.
          </div>
          <div class="alert" id="triagem_alert" role="alert" aria-live="assertive">
            <strong>Aten√ß√£o!</strong>
            <span id="triagem_alert_message"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- DADOS POR AMOSTRA -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Amostra vinculada</label>
        <select id="select-amostra">
          <option value="">Selecione uma amostra...</option>
        </select>
      </div>

      <div id="contador-amostras" class="contador-amostras"></div>

      <!-- DATA COLETA + CHECKBOX -->
      <div class="field">
        <label>Data da coleta</label>
        <input type="date" id="amostra-data-coleta" />
        <label class="checkbox-item" style="margin-top:6px; width:max-content;">
          <input type="checkbox" id="check-data-rasurada" />
          <span>Data rasurada</span>
        </label>
      </div>

      <!-- DATA VALIDADE + CHECKBOX -->
      <div class="field">
        <label>Data de validade</label>
        <input type="date" id="amostra-data-validade" />
        <label class="checkbox-item" style="margin-top:6px; width:max-content;">
          <input type="checkbox" id="check-sem-validade" />
          <span>Sem data de validade</span>
        </label>
      </div>
    </div>

    <!-- CHECKBOXES FINAIS EM 2x2 -->
    <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; margin-top:12px;">

      <!-- Linha 1 -->
      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-sem-identificacao" />
          <span>Amostra sem identifica√ß√£o ‚Äì bi√≥psia / swab</span>
        </label>
      </div>

      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-armazenamento-inadequado" />
          <span>Armazenamento inadequado</span>
        </label>
        <div class="multiselect-dropdown" id="multiselect-motivo-armazenamento">
          <button type="button" class="multiselect-btn" disabled>
            <span class="multiselect-text">Selecione o motivo...</span>
            <span class="multiselect-arrow">‚ñº</span>
          </button>
          <div class="multiselect-options">
            <!-- Options ser√£o carregados dinamicamente via JS -->
          </div>
        </div>
      </div>

      <!-- Linha 2 -->
      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-frasco-trocado" />
          <span>Frasco trocado ‚Äì tipo de coletor</span>
        </label>
      </div>

      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-material-nao-analisado" />
          <span>Tipo de material n√£o analisado pelo FEMME</span>
        </label>
      </div>

    </div>

    <!-- √ÅREA DE ERRO FIXA -->
    <div class="alert alert-validacao" id="triagem_alert_validacao" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="triagem_alert_validacao_message"></span>
    </div>

    <!-- A√á√ïES -->
    <div class="step-actions">
      <button class="btn btn-outline" type="button" id="btn-cancelar-triagem">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-seguir-triagem">SEGUIR</button>
    </div>

  </div>
</section>

<!-- √ÅREA DIN√ÇMICA - ETAPA 2 DA TRIAGEM (INICIALMENTE OCULTA) -->
<section class="card" id="triagem-step2-container" style="display: none;">
  <div class="triagem-step">

    <div class="step-header">
      <div>
        <span class="step-badge step-badge-etapa2">Etapa 2 ¬∑ Confer√™ncia de pend√™ncias</span>
      </div>
      <div style="font-size:11px; color:var(--femme-gray);">
        Requisi√ß√£o <strong id="req-codigo-display-e2">#---</strong> ¬∑ C√≥d. barras <strong id="req-barras-display-e2">---</strong>
      </div>
    </div>

    <!-- CAMPOS INFORMATIVOS -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Id da requisi√ß√£o</label>
        <input type="text" id="req-id-e2" readonly />
      </div>

      <div class="field">
        <label>C√≥digo de barras bipado</label>
        <input type="text" id="req-cod-barras-e2" readonly />
      </div>

      <div class="field">
        <label>Data de recebimento</label>
        <input type="date" id="req-data-recebimento-e2" readonly />
      </div>
    </div>

    <!-- T√çTULO DA SE√á√ÉO DE PEND√äNCIAS -->
    <div class="pendencias-header">
      <h4>Marque as pend√™ncias encontradas na requisi√ß√£o:</h4>
      <p class="info-inline">Se n√£o houver pend√™ncias, deixe todos os campos desmarcados e clique em Finalizar.</p>
    </div>

    <!-- CHECKBOXES DE PEND√äNCIAS EM GRID 2 COLUNAS -->
    <div class="pendencias-grid" id="pendencias-checkboxes">
      <!-- Checkboxes ser√£o carregados dinamicamente via JS -->
    </div>

    <!-- √ÅREA DE ERRO -->
    <div class="alert alert-validacao" id="triagem2_alert_validacao" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="triagem2_alert_validacao_message"></span>
    </div>

    <!-- A√á√ïES -->
    <div class="step-actions">
      <button class="btn btn-outline" type="button" id="btn-cancelar-triagem2">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-finalizar-triagem2">SEGUIR</button>
    </div>

  </div>
</section>

<!-- √ÅREA DIN√ÇMICA - ETAPA 3 DA TRIAGEM - CADASTRO (INICIALMENTE OCULTA) -->
<section class="card" id="triagem-step3-container" style="display: none;">
  <div class="triagem-step">

    <div class="step-header">
      <div>
        <span class="step-badge step-badge-etapa3">Etapa 3 ¬∑ Triagem</span>
      </div>
      <div style="font-size:11px; color:var(--femme-gray);">
        Requisi√ß√£o <strong id="req-codigo-display-e3">#---</strong> ¬∑ C√≥d. barras <strong id="req-barras-display-e3">---</strong>
      </div>
    </div>

    <!-- SE√á√ÉO DE FRASCOS/AMOSTRAS -->
    <div class="amostras-section">
      <div class="amostras-header">
        <h4>Frascos / Amostras vinculadas</h4>
        <button class="btn btn-outline btn-sm" type="button" id="btn-adicionar-frasco">
          + Adicionar frasco
        </button>
      </div>

      <div class="amostras-grid" id="amostras-grid-e3">
        <!-- Amostras ser√£o carregadas dinamicamente via JS -->
      </div>
    </div>

    <div class="divider"></div>

    <!-- CPF + A√á√ïES + CHECKBOX -->
    <div class="cpf-actions">
      <div class="field">
        <label class="label-strong">CPF Paciente</label>
        <input type="text" id="cpf-paciente" placeholder="000.000.000-00" maxlength="14" />
      </div>

      <button class="btn btn-outline" type="button" id="btn-cpf-korus" title="Consultar CPF na base FEMME">CPF Korus</button>
      <button class="btn btn-muted" type="button" id="btn-rodar-ocr" disabled title="API em desenvolvimento">Rodar OCR</button>
      <button class="btn btn-muted" type="button" id="btn-cpf-receita" disabled title="API em desenvolvimento">CPF Receita</button>

      <label class="check-inline">
        <input type="checkbox" id="check-problema-cpf" />
        Problema com CPF
      </label>

      <button class="btn btn-outline" type="button" id="btn-ver-imagem-requisicao" title="Ver imagem digitalizada da requisi√ß√£o">Ver imagem requisi√ß√£o</button>
    </div>

    <!-- √ÅREA DE ALERTA ETAPA 3 (abaixo do CPF) -->
    <div class="alert alert-validacao" id="triagem3_alert_validacao" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="triagem3_alert_validacao_message"></span>
    </div>

    <!-- NOME PACIENTE -->
    <div class="row">
      <div class="field">
        <label class="label-strong">Nome paciente</label>
        <input type="text" id="nome-paciente" placeholder="Nome do paciente" />
      </div>
    </div>

    <!-- CRM / UF-CRM / VALIDA + CHECKBOX -->
    <div class="row three">
      <div class="field">
        <label class="label-strong">CRM</label>
        <input type="text" id="crm-medico" placeholder="N√∫mero do CRM" pattern="[0-9]*" inputmode="numeric" />
      </div>

      <div class="field">
        <label class="label-strong">UF-CRM</label>
        <div class="custom-dropdown-wrapper" id="uf-crm-wrapper">
          <input type="text" id="uf-crm" placeholder="Digite ou selecione..." maxlength="2" style="text-transform: uppercase;" autocomplete="off" />
          <div class="custom-dropdown-list" id="uf-crm-dropdown">
            <div class="custom-dropdown-item" data-value="AC">AC</div>
            <div class="custom-dropdown-item" data-value="AL">AL</div>
            <div class="custom-dropdown-item" data-value="AM">AM</div>
            <div class="custom-dropdown-item" data-value="AP">AP</div>
            <div class="custom-dropdown-item" data-value="BA">BA</div>
            <div class="custom-dropdown-item" data-value="CE">CE</div>
            <div class="custom-dropdown-item" data-value="DF">DF</div>
            <div class="custom-dropdown-item" data-value="ES">ES</div>
            <div class="custom-dropdown-item" data-value="GO">GO</div>
            <div class="custom-dropdown-item" data-value="MA">MA</div>
            <div class="custom-dropdown-item" data-value="MG">MG</div>
            <div class="custom-dropdown-item" data-value="MS">MS</div>
            <div class="custom-dropdown-item" data-value="MT">MT</div>
            <div class="custom-dropdown-item" data-value="PA">PA</div>
            <div class="custom-dropdown-item" data-value="PB">PB</div>
            <div class="custom-dropdown-item" data-value="PE">PE</div>
            <div class="custom-dropdown-item" data-value="PI">PI</div>
            <div class="custom-dropdown-item" data-value="PR">PR</div>
            <div class="custom-dropdown-item" data-value="RJ">RJ</div>
            <div class="custom-dropdown-item" data-value="RN">RN</div>
            <div class="custom-dropdown-item" data-value="RO">RO</div>
            <div class="custom-dropdown-item" data-value="RR">RR</div>
            <div class="custom-dropdown-item" data-value="RS">RS</div>
            <div class="custom-dropdown-item" data-value="SC">SC</div>
            <div class="custom-dropdown-item" data-value="SE">SE</div>
            <div class="custom-dropdown-item" data-value="SP">SP</div>
            <div class="custom-dropdown-item" data-value="TO">TO</div>
          </div>
        </div>
      </div>

      <div class="field field-actions">
        <button class="btn btn-muted" type="button" id="btn-valida-medico" disabled title="API em desenvolvimento">Valida m√©dico</button>
        <label class="check-inline">
          <input type="checkbox" id="check-problema-medico" />
          Dados m√©dico com problema
        </label>
      </div>
    </div>

    <!-- NOME DO M√âDICO -->
    <div class="row">
      <div class="field">
        <label class="label-strong">Nome do m√©dico</label>
        <input type="text" id="nome-medico" readonly placeholder="Preenchido via API Valida M√©dico" />
      </div>
    </div>

    <!-- ENDERE√áO + DESTINO -->
    <div class="row two">
      <div class="field">
        <label class="label-strong">Endere√ßo m√©dico</label>
        <input type="text" id="endereco-medico" readonly placeholder="Preenchido via API Valida M√©dico" />
      </div>

      <div class="field">
        <label class="label-strong">Destino</label>
        <input type="text" id="destino-medico" readonly placeholder="Preenchido via API Valida M√©dico" />
      </div>
    </div>

    <!-- CARREGAR IMAGEM -->
    <div class="row">
      <div class="field">
        <span class="label-strong">Upload imagens (n√£o obrigat√≥rio)</span>
        <div class="scanner-box">
          <div class="scanner-row">
            <button class="btn btn-outline" type="button" id="btn-carregar-imagem-e3">üìÅ Carregar Imagem</button>
            <input type="file" id="input-upload-imagem-e3" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none;" />
            <!-- Arquivos aparecer√£o aqui dinamicamente -->
            <div id="upload-files-container-e3"></div>
          </div>
          <div class="info-inline" id="info-formatos-aceitos-e3">
            Selecione um ou mais arquivos. Formatos aceitos: PDF, JPG, JPEG, PNG.
          </div>
        </div>
      </div>
    </div>

    <!-- √ÅREA DE ERRO -->
    <div class="alert alert-validacao" id="triagem3_alert_validacao" role="alert" aria-live="assertive">
      <strong>Aten√ß√£o!</strong>
      <span id="triagem3_alert_validacao_message"></span>
    </div>

    <!-- A√á√ïES -->
    <div class="step-actions">
      <button class="btn btn-outline" type="button" id="btn-cancelar-triagem3">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-seguir-cadastro">SEGUIR PARA CADASTRO</button>
    </div>

  </div>
</section>

<!-- MODAL CONFIRMAR EXCLUS√ÉO DE AMOSTRA -->
<div class="modal-overlay" id="modal-excluir-amostra" style="display: none;">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Excluir Amostra</h3>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir esta amostra?</p>
      <p class="text-muted" id="amostra-excluir-info">C√≥digo: ---</p>
      <div class="field" style="margin-top: 12px;">
        <label class="label-strong">Motivo da exclus√£o <span class="text-danger">*</span></label>
        <select id="motivo-exclusao-amostra" required>
          <option value="">Selecione o motivo...</option>
          <!-- Op√ß√µes ser√£o carregadas via JS -->
        </select>
      </div>
      <p class="text-danger" style="margin-top: 12px;"><strong>Esta a√ß√£o n√£o pode ser desfeita.</strong></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btn-cancelar-excluir-amostra">Cancelar</button>
      <button class="btn btn-danger" type="button" id="btn-confirmar-excluir-amostra">Excluir</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAR ADI√á√ÉO DE AMOSTRA -->
<div class="modal-overlay" id="modal-adicionar-amostra" style="display: none;">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h3>‚ûï Adicionar Amostra</h3>
    </div>
    <div class="modal-body">
      <p>Adicione uma nova amostra a esta requisi√ß√£o.</p>
      <div class="info-inline" style="margin: 12px 0;">
        <strong>Importante:</strong> O c√≥digo de barras da amostra deve ser igual ao c√≥digo de barras da requisi√ß√£o.
      </div>
      <div class="field" style="margin-top: 12px;">
        <label class="label-strong">Motivo da adi√ß√£o <span class="text-danger">*</span></label>
        <select id="motivo-adicao-amostra">
          <option value="">Selecione o motivo...</option>
        </select>
      </div>
      <div class="field" style="margin-top: 12px;">
        <label class="label-strong">C√≥digo de barras da nova amostra <span class="text-danger">*</span></label>
        <input type="text" id="nova-amostra-cod-barras" placeholder="Bipe ou digite o c√≥digo de barras" autocomplete="off" />
      </div>
      <div class="alert alert-danger" id="erro-adicionar-amostra" style="display: none; margin-top: 12px;">
        <span id="erro-adicionar-amostra-msg"></span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btn-cancelar-adicionar-amostra">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-confirmar-adicionar-amostra">Adicionar</button>
    </div>
  </div>
</div>

<!-- MODAL AVISO DE PEND√äNCIAS -->
<div class="modal-overlay" id="modal-aviso-pendencias" style="display: none;">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Aten√ß√£o - Pend√™ncias Identificadas</h3>
    </div>
    <div class="modal-body">
      <p>Foram identificadas as seguintes pend√™ncias nesta requisi√ß√£o:</p>
      <ul id="lista-pendencias-modal" style="margin: 12px 0; padding-left: 20px;">
        <!-- Pend√™ncias ser√£o listadas via JS -->
      </ul>
      <div class="info-inline" style="margin-top: 12px;">
        <strong>Voc√™ pode:</strong>
        <ul style="margin-top: 8px; padding-left: 20px;">
          <li>Corrigir as informa√ß√µes e tentar novamente</li>
          <li>Confirmar e enviar para a fila de pend√™ncias</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btn-voltar-corrigir">Voltar e Corrigir</button>
      <button class="btn btn-warning" type="button" id="btn-confirmar-pendencia">Enviar para Pend√™ncias</button>
    </div>
  </div>
</div>

<!-- MODAL DE SCANNER - LAYOUT ELEGANTE FEMME -->
<div class="scanner-overlay" id="modal-scanner-teste" style="display: none;">
  <div class="scanner-modal">
    <!-- Header -->
    <div class="scanner-modal-header">
      <div class="scanner-modal-title">
        <h2>üìÑ Digitalizar requisi√ß√£o</h2>
        <span>Use o scanner conectado para capturar o papel da requisi√ß√£o.</span>
      </div>
      <button class="scanner-modal-close" type="button" id="btn-fechar-modal" aria-label="Fechar modal">‚úï</button>
    </div>
    
    <!-- Body -->
    <div class="scanner-modal-body">
      <!-- Viewer + toolbar -->
      <div class="scanner-viewer">
        <!-- Toolbar Elegante -->
        <div class="scanner-toolbar">
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Remover p√°gina atual" id="btn-remove-current" aria-label="Remover p√°gina atual">üóëÔ∏è</button>
            <button type="button" class="scanner-tool-btn" title="Remover todas as p√°ginas" id="btn-remove-all" aria-label="Remover todas as p√°ginas">üóëÔ∏èüóëÔ∏è</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Diminuir zoom" id="btn-zoom-out" aria-label="Diminuir zoom">‚ûñ</button>
            <span class="scanner-page-info">
              <input type="text" id="DW_spanZoom" readonly style="width:40px;border:none;background:transparent;text-align:center;font-size:11px;color:#34343a;">
            </span>
            <button type="button" class="scanner-tool-btn" title="Aumentar zoom" id="btn-zoom-in" aria-label="Aumentar zoom">‚ûï</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Girar √† esquerda" id="btn-rotate" aria-label="Girar imagem √† esquerda">‚Ü∫</button>
            <button type="button" class="scanner-tool-btn" title="Tamanho original" id="btn-original-size" aria-label="Restaurar tamanho original">‚äü</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Ferramenta de m√£o para mover imagem" id="btn-hand" aria-label="Ativar ferramenta de m√£o">üñêÔ∏è</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <span class="scanner-page-info">
            P√°g. <input type="text" id="DW_CurrentImage" readonly style="width:24px;border:none;background:transparent;text-align:center;"> / 
            <input type="text" id="DW_TotalImage" readonly style="width:24px;border:none;background:transparent;text-align:center;">
          </span>
        </div>
        
        <!-- Viewer do Dynamsoft -->
        <div id="dwtcontrolContainer" style="width:100%;min-height:360px;border-radius:10px;background:#fff;"></div>
      </div>
      
      <!-- Config / a√ß√µes -->
      <div class="scanner-config">
        <div class="scanner-config-title">Configura√ß√µes do scanner</div>
        
        <div>
          <label for="scanner-select">Scanner conectado</label>
          <select id="scanner-select">
            <option>Carregando scanners...</option>
          </select>
        </div>
        
        <div style="margin-top:10px;">
          <label for="resolution-select">Resolu√ß√£o (DPI)</label>
          <select id="resolution-select">
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200" selected>200</option>
            <option value="300">300</option>
          </select>
        </div>
        
        <div class="scanner-actions">
          <button type="button" class="btn-pill-primary" id="btn-carregar-imagem">üìÅ Carregar Imagem</button>
          <button type="button" class="btn-pill-primary" id="btn-digitalizar">üì∑ Digitalizar</button>
          <button type="button" class="btn-pill-primary" id="btn-enviar-aws">üì§ Enviar</button>
          <button type="button" class="btn-pill-ghost" id="btn-fechar-modal-footer">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Confirmar Substitui√ß√£o de Arquivo -->
<div id="modal-confirmar-substituicao" class="modal-overlay" style="display:none;">
  <div class="modal-container" style="max-width:500px;">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Arquivo Existente</h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:15px;">
        J√° existe um arquivo digitalizado para esta requisi√ß√£o.
      </p>
      <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:15px;">
        <strong>Arquivo atual:</strong><br>
        <span id="arquivo-existente-nome" style="font-size:0.9em;color:#666;"></span>
      </div>
      <p style="color:#d32f2f;font-weight:500;">
        Se voc√™ prosseguir, o arquivo atual ser√° descartado e um novo arquivo ser√° digitalizado.
      </p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-pill-primary" id="btn-confirmar-substituicao">
        Prosseguir e Substituir
      </button>
      <button type="button" class="btn-pill-ghost" id="btn-cancelar-substituicao">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal: Confirmar Exclus√£o de Arquivo -->
<div id="modal-confirmar-exclusao" class="modal-overlay" style="display:none;">
  <div class="modal-container" style="max-width:450px;">
    <div class="modal-header">
      <h3>üóëÔ∏è Confirmar Exclus√£o</h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:10px;">
        Tem certeza que deseja deletar este arquivo?
      </p>
      <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:10px;">
        <strong id="arquivo-deletar-nome" style="font-size:0.9em;color:#666;"></strong>
      </div>
      <p style="color:#d32f2f;font-size:0.9em;">
        Esta a√ß√£o n√£o pode ser desfeita.
      </p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-pill-danger" id="btn-confirmar-exclusao">
        Deletar Arquivo
      </button>
      <button type="button" class="btn-pill-ghost" id="btn-cancelar-exclusao">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal: Visualizar Imagem da Requisi√ß√£o -->
<div id="modal-ver-imagem" class="modal-overlay" style="display:none;">
  <div class="modal-container" style="max-width:90vw; max-height:90vh;">
    <div class="modal-header" style="background: linear-gradient(135deg, #e3f2fd 0%, #fff 100%);">
      <h3 style="color: #1565c0;">üñºÔ∏è Imagem da Requisi√ß√£o</h3>
      <button type="button" class="modal-close-btn" id="btn-fechar-modal-imagem" title="Fechar">&times;</button>
    </div>
    <div class="modal-body" style="padding: 16px; text-align: center; overflow: auto; max-height: calc(90vh - 120px);">
      <div id="imagem-requisicao-container" style="display:none;">
        <img id="imagem-requisicao" src="" alt="Imagem da requisi√ß√£o" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;" />
      </div>
      <div id="pdf-requisicao-container" style="display:none;">
        <iframe id="pdf-requisicao" src="" style="width: 100%; height: 70vh; border: 1px solid #ddd; border-radius: 8px;"></iframe>
      </div>
      <div id="imagem-requisicao-loading" style="display:none; padding: 40px;">
        <span>‚è≥ Carregando arquivo...</span>
      </div>
      <div id="imagem-requisicao-erro" style="display:none; padding: 40px; color: #c62828;">
        <span>‚ùå Nenhum arquivo dispon√≠vel para esta requisi√ß√£o.</span>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-pill-ghost" id="btn-fechar-imagem">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal: Confirma√ß√£o de Pend√™ncias (Etapa 2) -->
<div id="modal-confirmar-pendencias" class="modal-overlay" style="display:none;">
  <div class="modal-container" style="max-width:550px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #fff3e0 0%, #fff 100%);">
      <h3 style="color: #e65100;">üìã Confirmar Pend√™ncias</h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px; font-weight: 500;">
        As seguintes pend√™ncias ser√£o registradas para esta requisi√ß√£o:
      </p>
      <ul id="lista-pendencias-confirmacao" style="margin: 16px 0; padding-left: 20px; line-height: 1.8;">
        <!-- Preenchido via JS -->
      </ul>
      <div style="background:#fff3cd; padding:12px; border-radius:6px; border-left:4px solid #ffc107; margin-top:16px;">
        <strong>Status de destino:</strong>
        <span style="color:#856404;">PEND√äNCIA</span>
      </div>
      <p style="margin-top:16px; font-size:0.9em; color:#666;">
        Deseja confirmar o registro das pend√™ncias ou cancelar para fazer corre√ß√µes?
      </p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-pill-primary" id="btn-confirmar-pendencias">
        ‚úÖ Continuar
      </button>
      <button type="button" class="btn-pill-ghost" id="btn-cancelar-pendencias">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal: Impeditivos e Rejei√ß√£o -->
<div id="modal-rejeicao" class="modal-overlay" style="display:none;">
  <div class="modal-container" style="max-width:550px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #fce4ec 0%, #fff 100%);">
      <h3 style="color: #c62828;">‚ö†Ô∏è Requisi√ß√£o N√£o Apta para Prosseguir</h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px; font-weight: 500;">
        A requisi√ß√£o apresenta os seguintes impeditivos:
      </p>
      <ul id="lista-impeditivos" style="margin: 16px 0; padding-left: 20px; line-height: 1.8;">
        <!-- Preenchido via JS -->
      </ul>
      <div style="background:#fff3cd; padding:12px; border-radius:6px; border-left:4px solid #ffc107; margin-top:16px;">
        <strong>Status de destino:</strong>
        <span id="status-rejeicao-nome" style="color:#856404;"></span>
      </div>
      <p style="margin-top:16px; font-size:0.9em; color:#666;">
        Deseja confirmar o envio para rejei√ß√£o ou cancelar para fazer corre√ß√µes?
      </p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-pill-danger" id="btn-confirmar-rejeicao">
        Confirmar Rejei√ß√£o
      </button>
      <button type="button" class="btn-pill-ghost" id="btn-cancelar-rejeicao">
        Cancelar
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Configura√ß√µes e Ambiente -->
<script src="{% static 'js/config.js' %}"></script>

<!-- Gerenciador de Arquivos -->
<script src="{% static 'js/arquivo-manager.js' %}"></script>

<!-- M√≥dulo do Scanner Dynamsoft -->
<script src="{% static 'js/scanner.js' %}"></script>

<script>
// ============================================
// INICIALIZA√á√ÉO DO SCANNER DYNAMSOFT
// ============================================

// Inicializar m√≥dulo do scanner com licen√ßa do Django
DynamosoftScanner.init('{{ dynamsoft_license }}', {% if DEBUG %}true{% else %}false{% endif %});
</script>

<!-- M√≥dulo da p√°gina de Triagem -->
<script src="{% static 'js/triagem.js' %}"></script>
{% endblock %}

