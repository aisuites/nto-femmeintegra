{% extends "base_app.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/triagem.css' %}" />
<link rel="stylesheet" href="{% static 'css/scanner-modal.css' %}" />
<link rel="stylesheet" href="{% static 'css/dynamsoft_toolbar_only.css' %}" />
{% endblock %}

{% block main_content %}
<!-- SE√á√ÉO BIPAGEM (CONTE√öDO FIXO) -->
<section class="card">
  <div class="barcode-section">
    <div>
      <div class="section-kicker">Triagem</div>
      <div class="section-title">Localizar requisi√ß√£o para triagem</div>
      <div class="section-subtitle">
        Bipe o c√≥digo de barras da requisi√ß√£o ou digite manualmente para iniciar a etapa de triagem.
      </div>
    </div>

    <div class="barcode-row">
      <input 
        type="text" 
        id="input-cod-barras-triagem" 
        placeholder="Bipe ou digite o c√≥digo de barras da requisi√ß√£o"
        autocomplete="off"
      />
      <button class="btn btn-primary" type="button" id="btn-localizar-triagem">
        üîç Localizar
      </button>
    </div>

    <div class="info-inline">
      ‚Ä¢ Ap√≥s localizar, a etapa da triagem ser√° carregada abaixo de acordo com o status da requisi√ß√£o.
    </div>
  </div>
</section>

<!-- √ÅREA DIN√ÇMICA - ETAPA 1 DA TRIAGEM (INICIALMENTE OCULTA) -->
<section class="card" id="triagem-step-container" style="display: none;">
  <div class="triagem-step">

    <div class="step-header">
      <div>
        <span class="step-badge">Etapa 1 ¬∑ Confer√™ncia de dados e amostras</span>
      </div>
      <div style="font-size:11px; color:var(--femme-gray);">
        Requisi√ß√£o <strong id="req-codigo-display">#---</strong> ¬∑ C√≥d. barras <strong id="req-barras-display">---</strong>
      </div>
    </div>

    <!-- CAMPOS PRINCIPAIS -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Id da requisi√ß√£o</label>
        <input type="text" id="req-id" readonly />
      </div>

      <div class="field">
        <label>C√≥digo de barras bipado</label>
        <input type="text" id="req-cod-barras" readonly />
      </div>

      <div class="field">
        <label>Data de recebimento</label>
        <input type="date" id="req-data-recebimento" />
      </div>

      <!-- SCANNER -->
      <div class="field">
        <label>Digitaliza√ß√£o da requisi√ß√£o (Scanner)</label>
        <div class="scanner-box">
          <div class="scanner-row">
            <button class="btn btn-outline" type="button" id="btn-scanner">üì† SCANNER</button>
            <!-- Arquivos aparecer√£o aqui dinamicamente -->
            <div id="scanner-files-container"></div>
          </div>
          <div class="info-inline">
            Obrigat√≥rio: 1 imagem por requisi√ß√£o. Se necess√°rio, exclua e fa√ßa novo scan.
          </div>
        </div>
      </div>
    </div>

    <!-- DADOS POR AMOSTRA -->
    <div class="fields-grid-2col">
      <div class="field">
        <label>Amostra vinculada</label>
        <select id="select-amostra">
          <option value="">Selecione uma amostra...</option>
        </select>
      </div>

      <div></div>

      <!-- DATA COLETA + CHECKBOX -->
      <div class="field">
        <label>Data da coleta</label>
        <input type="date" id="amostra-data-coleta" />
        <label class="checkbox-item" style="margin-top:6px; width:max-content;">
          <input type="checkbox" id="check-data-rasurada" />
          <span>Data rasurada</span>
        </label>
      </div>

      <!-- DATA VALIDADE + CHECKBOX -->
      <div class="field">
        <label>Data de validade</label>
        <input type="date" id="amostra-data-validade" />
        <label class="checkbox-item" style="margin-top:6px; width:max-content;">
          <input type="checkbox" id="check-sem-validade" />
          <span>Sem data de validade</span>
        </label>
      </div>
    </div>

    <!-- CHECKBOXES FINAIS EM 2x2 -->
    <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; margin-top:12px;">

      <!-- Linha 1 -->
      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-sem-identificacao" />
          <span>Amostra sem identifica√ß√£o ‚Äì bi√≥psia / swab</span>
        </label>
      </div>

      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-armazenamento-inadequado" />
          <span>Armazenamento inadequado</span>
        </label>
        <select class="inline-dropdown" id="select-motivo-armazenamento" disabled>
          <option value="">Selecione o motivo‚Ä¶</option>
          <option value="temperatura">Temperatura fora do padr√£o</option>
          <option value="transporte">Transporte inadequado</option>
          <option value="tempo">Tempo de guarda excedido</option>
        </select>
      </div>

      <!-- Linha 2 -->
      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-frasco-trocado" />
          <span>Frasco trocado ‚Äì tipo de coletor</span>
        </label>
      </div>

      <div class="checkbox-wrapper">
        <label class="checkbox-item-inline">
          <input type="checkbox" id="check-material-nao-analisado" />
          <span>Tipo de material n√£o analisado pelo FEMME</span>
        </label>
      </div>

    </div>

    <!-- A√á√ïES -->
    <div class="step-actions">
      <button class="btn btn-outline" type="button" id="btn-cancelar-triagem">Cancelar</button>
      <button class="btn btn-primary" type="button" id="btn-seguir-triagem">SEGUIR</button>
    </div>

  </div>
</section>

<!-- MODAL DE SCANNER - LAYOUT ELEGANTE FEMME -->
<div class="scanner-overlay" id="modal-scanner-teste" style="display: none;">
  <div class="scanner-modal">
    <!-- Header -->
    <div class="scanner-modal-header">
      <div class="scanner-modal-title">
        <h2>üìÑ Digitalizar requisi√ß√£o</h2>
        <span>Use o scanner conectado para capturar o papel da requisi√ß√£o.</span>
      </div>
      <button class="scanner-modal-close" type="button" id="btn-fechar-modal" aria-label="Fechar modal">‚úï</button>
    </div>
    
    <!-- Body -->
    <div class="scanner-modal-body">
      <!-- Viewer + toolbar -->
      <div class="scanner-viewer">
        <!-- Toolbar Elegante -->
        <div class="scanner-toolbar">
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Remover p√°gina atual" id="btn-remove-current" aria-label="Remover p√°gina atual">üóëÔ∏è</button>
            <button type="button" class="scanner-tool-btn" title="Remover todas as p√°ginas" id="btn-remove-all" aria-label="Remover todas as p√°ginas">üóëÔ∏èüóëÔ∏è</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Diminuir zoom" id="btn-zoom-out" aria-label="Diminuir zoom">‚ûñ</button>
            <span class="scanner-page-info">
              <input type="text" id="DW_spanZoom" readonly style="width:40px;border:none;background:transparent;text-align:center;font-size:11px;color:#34343a;">
            </span>
            <button type="button" class="scanner-tool-btn" title="Aumentar zoom" id="btn-zoom-in" aria-label="Aumentar zoom">‚ûï</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Girar √† esquerda" id="btn-rotate" aria-label="Girar imagem √† esquerda">‚Üª</button>
            <button type="button" class="scanner-tool-btn" title="Tamanho original" id="btn-original-size" aria-label="Restaurar tamanho original">‚äü</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <div class="scanner-toolbar-group">
            <button type="button" class="scanner-tool-btn" title="Ferramenta de m√£o para mover imagem" id="btn-hand" aria-label="Ativar ferramenta de m√£o">üñêÔ∏è</button>
          </div>
          
          <span class="scanner-toolbar-separator"></span>
          
          <span class="scanner-page-info">
            P√°g. <input type="text" id="DW_CurrentImage" readonly style="width:24px;border:none;background:transparent;text-align:center;"> / 
            <input type="text" id="DW_TotalImage" readonly style="width:24px;border:none;background:transparent;text-align:center;">
          </span>
        </div>
        
        <!-- Viewer do Dynamsoft -->
        <div id="dwtcontrolContainer" style="width:100%;min-height:360px;border-radius:10px;background:#fff;"></div>
      </div>
      
      <!-- Config / a√ß√µes -->
      <div class="scanner-config">
        <div class="scanner-config-title">Configura√ß√µes do scanner</div>
        
        <div>
          <label for="scanner-select">Scanner conectado</label>
          <select id="scanner-select">
            <option>Carregando scanners...</option>
          </select>
        </div>
        
        <div style="margin-top:10px;">
          <label for="resolution-select">Resolu√ß√£o (DPI)</label>
          <select id="resolution-select">
            <option value="100">100</option>
            <option value="150">150</option>
            <option value="200" selected>200</option>
            <option value="300">300</option>
          </select>
        </div>
        
        <div class="scanner-actions">
          <button type="button" class="btn-pill-primary" id="btn-carregar-imagem">üìÅ Carregar Imagem</button>
          <button type="button" class="btn-pill-primary" id="btn-digitalizar">üì∑ Digitalizar</button>
          <button type="button" class="btn-pill-primary" id="btn-enviar-aws">üì§ Enviar</button>
          <button type="button" class="btn-pill-ghost" id="btn-fechar-modal-footer">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// ============================================
// M√ìDULO DO SCANNER - Encapsulado para seguran√ßa
// ============================================
(function() {
  'use strict';
  
  // ============================================
  // CONSTANTES
  // ============================================
  const SCANNER_TIMEOUT = 60000; // 60 segundos
  const PIXEL_TYPE_COLOR = 2; // 0=P&B, 1=Cinza, 2=Color
  const PIXEL_TYPE_GRAYSCALE = 1;
  const PIXEL_TYPE_BW = 0;
  const DEFAULT_RESOLUTION = 200; // DPI
  const ERROR_CODE_TIMEOUT = -2415;
  const ZOOM_STEP = 5; // Incremento de zoom em %
  const ZOOM_MAX = 6500; // Zoom m√°ximo em %
  
  // Vari√°veis privadas (n√£o acess√≠veis externamente)
  let DWTObject = null;
  let dynamosoftScriptsCarregados = false;
  let eventListenersConfigurados = false;
  
  // Fun√ß√£o p√∫blica para abrir modal (exposta via window)
  function abrirModalScanner() {
    // Verificar se h√° requisi√ß√£o selecionada
    if (typeof requisicaoAtual !== 'undefined' && requisicaoAtual) {
      
      // Abrir modal de scanner
      abrirModal();
      
    } else {
      alert('‚ö†Ô∏è Por favor, localize uma requisi√ß√£o primeiro.');
    }
  }
  
  // Expor apenas a fun√ß√£o necess√°ria globalmente
  window.abrirModalScanner = abrirModalScanner;
  
  // === FUN√á√ïES DO MODAL DE SCANNER ===
  function abrirModal() {
    const modal = document.getElementById('modal-scanner-teste');
    if (modal) {
      modal.style.display = 'flex';
      
      // Configurar event listeners apenas uma vez
      if (!eventListenersConfigurados) {
        configurarEventListeners();
        eventListenersConfigurados = true;
      }
      
      // Carregar scripts do Dynamsoft se ainda n√£o foram carregados
      if (!dynamosoftScriptsCarregados) {
        carregarScriptsDynamsoft();
      }
    }
  }
  
  function carregarScriptsDynamsoft() {
    console.log('\n\n');
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  üîç DEBUG COMPLETO - CARREGAMENTO LICEN√áA DYNAMSOFT          ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log('\nüìç ETAPA 1: ANTES DE CARREGAR SCRIPTS');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    // Verificar estado inicial
    console.log('window.Dynamsoft existe?', typeof window.Dynamsoft !== 'undefined');
    console.log('window.Dynamsoft.DWT existe?', typeof window.Dynamsoft?.DWT !== 'undefined');
    
    // Configurar ResourcesPath e ProductKey ANTES de carregar scripts
    window.Dynamsoft = window.Dynamsoft || {};
    Dynamsoft.DWT = Dynamsoft.DWT || {};
    Dynamsoft.DWT.ResourcesPath = '/static/dynamsoft';
    
    // N√ÉO configurar ProductKey aqui - deixar o config.js fazer isso
    console.log('\nüîß Configura√ß√µes iniciais:');
    console.log('ResourcesPath:', Dynamsoft.DWT.ResourcesPath);
    console.log('ProductKey (antes dos scripts):', Dynamsoft.DWT.ProductKey || 'N√ÉO DEFINIDA');
    
    // Lista de scripts para carregar (com timestamp para evitar cache)
    const timestamp = new Date().getTime();
    const scripts = [
      '{% static "dynamsoft/dynamsoft.webtwain.initiate.js" %}' + '?v=' + timestamp,
      '{% static "dynamsoft/dynamsoft.webtwain.config.js" %}' + '?v=' + timestamp
    ];
    
    console.log('üì¶ URLs dos scripts (com anti-cache):');
    scripts.forEach((s, i) => console.log(`  ${i+1}. ${s}`));
    
    console.log('\nüì¶ Scripts a carregar:', scripts.length);
    scripts.forEach((s, i) => console.log(`  ${i+1}. ${s}`));
    
    let scriptsCarregadosCount = 0;
    
    scripts.forEach((src, index) => {
      const script = document.createElement('script');
      script.src = src;
      
      script.onload = () => {
        scriptsCarregadosCount++;
        console.log(`\n‚úÖ Script ${scriptsCarregadosCount}/${scripts.length} carregado: ${src.split('/').pop()}`);
        
        // Verificar ProductKey ap√≥s cada script
        console.log('   ProductKey agora:', Dynamsoft.DWT.ProductKey ? 
          Dynamsoft.DWT.ProductKey.substring(0, 30) + '... (tamanho: ' + Dynamsoft.DWT.ProductKey.length + ')' : 
          '‚ùå AINDA VAZIA');
        
        // Quando todos os scripts estiverem carregados
        if (scriptsCarregadosCount === scripts.length) {
          console.log('\nüìç ETAPA 2: TODOS OS SCRIPTS CARREGADOS');
          console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
          console.log('üîë ProductKey FINAL:', Dynamsoft.DWT.ProductKey ? 
            Dynamsoft.DWT.ProductKey.substring(0, 30) + '...' : '‚ùå VAZIA');
          console.log('üìè Tamanho:', Dynamsoft.DWT.ProductKey ? Dynamsoft.DWT.ProductKey.length : 0);
          console.log('‚úì V√°lida?', Dynamsoft.DWT.ProductKey && Dynamsoft.DWT.ProductKey.length > 100);
          console.log('\nüöÄ Iniciando Dynamsoft...\n');
          inicializarDynamsoft();
        }
      };
      
      script.onerror = () => {
        console.error('‚ùå ERRO ao carregar script:', src);
      };
      
      document.head.appendChild(script);
      console.log(`‚è≥ Carregando script ${index + 1}...`);
    });
    
    dynamosoftScriptsCarregados = true;
  }
  
  function inicializarDynamsoft() {
    console.log('\nüìç ETAPA 3: INICIALIZANDO DYNAMSOFT');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('üîë ProductKey no momento da inicializa√ß√£o:');
    console.log('   Existe?', !!Dynamsoft.DWT.ProductKey);
    console.log('   Tamanho:', Dynamsoft.DWT.ProductKey ? Dynamsoft.DWT.ProductKey.length : 0);
    console.log('   Primeiros 50 chars:', Dynamsoft.DWT.ProductKey ? Dynamsoft.DWT.ProductKey.substring(0, 50) + '...' : 'VAZIA');
    console.log('   LICEN√áA COMPLETA:', Dynamsoft.DWT.ProductKey || 'VAZIA');
    
    // Registrar callback quando Dynamsoft estiver pronto
    if (typeof Dynamsoft !== 'undefined' && Dynamsoft.DWT) {
      console.log('\nüìã Registrando eventos Dynamsoft...');
      
      // Registrar listener de erro ANTES de OnWebTwainReady
      Dynamsoft.DWT.RegisterEvent('OnWebTwainNotFound', function() {
        console.error('\n‚ùå OnWebTwainNotFound: Dynamsoft n√£o encontrado!');
      });
      
      Dynamsoft.DWT.RegisterEvent('OnWebTwainPreExecute', function() {
        console.log('\n‚è≥ OnWebTwainPreExecute: Preparando Dynamsoft...');
        console.log('   ProductKey neste momento:', Dynamsoft.DWT.ProductKey ? 
          Dynamsoft.DWT.ProductKey.substring(0, 30) + '...' : 'VAZIA');
      });
      
      Dynamsoft.DWT.RegisterEvent('OnWebTwainPostExecute', function() {
        console.log('\n‚úÖ OnWebTwainPostExecute: Dynamsoft executado!');
        console.log('   ProductKey ap√≥s execu√ß√£o:', Dynamsoft.DWT.ProductKey ? 
          Dynamsoft.DWT.ProductKey.substring(0, 30) + '...' : 'VAZIA');
      });
      
      Dynamsoft.DWT.RegisterEvent('OnWebTwainReady', function() {
        console.log('\nüìç ETAPA 4: DYNAMSOFT PRONTO (OnWebTwainReady)');
        console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        console.log('‚úÖ OnWebTwainReady disparado!');
        
        DWTObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer');
        
        if (DWTObject) {
          console.log('‚úÖ DWTObject criado com sucesso!');
          console.log('   Vers√£o:', DWTObject.VersionInfo);
          console.log('   ProductKey usado:', Dynamsoft.DWT.ProductKey ? 
            Dynamsoft.DWT.ProductKey.substring(0, 30) + '...' : 'VAZIA');
          DWTObject.Viewer.width = '100%';
          DWTObject.Viewer.height = '450px';
          DWTObject.Viewer.show();
          
          // IMPORTANTE: Ativar single page mode para zoom funcionar
          DWTObject.Viewer.singlePageMode = true;
          
          // Inicializar display de zoom
          if (document.getElementById("DW_spanZoom")) {
            var zoomInicial = DWTObject.Viewer?.zoom ? Math.round(DWTObject.Viewer.zoom * 100) : 100;
            document.getElementById("DW_spanZoom").value = zoomInicial + "%";
          }
          
          // Inicializar contador de p√°ginas
          if (document.getElementById("DW_CurrentImage") && document.getElementById("DW_TotalImage")) {
            document.getElementById("DW_CurrentImage").value = "0";
            document.getElementById("DW_TotalImage").value = "0";
          }
          
          
          // Listener para atualizar contador quando buffer mudar
          DWTObject.RegisterEvent('OnBufferChanged', function(changedIndex, changeType) {
            var total = DWTObject.HowManyImagesInBuffer;
            var current = total > 0 ? DWTObject.CurrentImageIndexInBuffer + 1 : 0;
            
            if (document.getElementById("DW_CurrentImage")) {
              document.getElementById("DW_CurrentImage").value = current;
            }
            if (document.getElementById("DW_TotalImage")) {
              document.getElementById("DW_TotalImage").value = total;
            }
          });
          
          // CARREGAR LISTA DE SCANNERS
          carregarListaScanners();
          
        } else {
          console.error('‚ùå Falha ao inicializar Dynamsoft');
        }
      });
    } else {
      console.error('‚ùå Dynamsoft n√£o est√° dispon√≠vel');
    }
  }
  
  function fecharModal() {
    const modal = document.getElementById('modal-scanner-teste');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  // === SUPORTE √Ä TECLA ESC ===
  function handleEscKey(event) {
    const modal = document.getElementById('modal-scanner-teste');
    // Verificar se modal est√° aberto e ESC foi pressionado
    if (modal && modal.style.display === 'flex' && event.key === 'Escape') {
      fecharModal();
    }
  }
  
  // Adicionar listener global para ESC (apenas uma vez)
  document.addEventListener('keydown', handleEscKey);
  
  // === CONFIGURAR EVENT LISTENERS DOS BOT√ïES ===
  function configurarEventListeners() {
    // Bot√µes de fechar
    const btnFecharHeader = document.getElementById('btn-fechar-modal');
    const btnFecharFooter = document.getElementById('btn-fechar-modal-footer');
    if (btnFecharHeader) btnFecharHeader.addEventListener('click', fecharModal);
    if (btnFecharFooter) btnFecharFooter.addEventListener('click', fecharModal);
    
    // Bot√µes da toolbar
    const btnRemoveCurrent = document.getElementById('btn-remove-current');
    const btnRemoveAll = document.getElementById('btn-remove-all');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnRotate = document.getElementById('btn-rotate');
    const btnOriginalSize = document.getElementById('btn-original-size');
    const btnHand = document.getElementById('btn-hand');
    
    if (btnRemoveCurrent) btnRemoveCurrent.addEventListener('click', btnRemoveCurrentImage_onclick);
    if (btnRemoveAll) btnRemoveAll.addEventListener('click', btnRemoveAllImages_onclick);
    if (btnZoomOut) btnZoomOut.addEventListener('click', btnZoomOut_onclick);
    if (btnZoomIn) btnZoomIn.addEventListener('click', btnZoomIn_onclick);
    if (btnRotate) btnRotate.addEventListener('click', btnRotateLeft_onclick);
    if (btnOriginalSize) btnOriginalSize.addEventListener('click', btnOrigSize_onclick);
    if (btnHand) btnHand.addEventListener('click', btnHand_onclick);
    
    // Bot√µes de a√ß√£o
    const btnCarregar = document.getElementById('btn-carregar-imagem');
    const btnDigitalizar = document.getElementById('btn-digitalizar');
    const btnEnviar = document.getElementById('btn-enviar-aws');
    
    if (btnCarregar) btnCarregar.addEventListener('click', carregarImagem);
    if (btnDigitalizar) btnDigitalizar.addEventListener('click', digitalizar);
    if (btnEnviar) btnEnviar.addEventListener('click', enviarParaAWS);
  }
  
  // === FUN√á√ÉO PARA CARREGAR LISTA DE SCANNERS ===
  function carregarListaScanners() {
    if (!DWTObject) {
      console.error('‚ùå DWTObject n√£o dispon√≠vel para carregar scanners');
      return;
    }
    
    
    DWTObject.GetDevicesAsync().then(function(devices) {
      
      var select = document.getElementById('scanner-select');
      if (!select) {
        console.error('‚ùå Select scanner-select n√£o encontrado');
        return;
      }
      
      // Limpar op√ß√µes antigas (m√©todo seguro)
      select.replaceChildren();
      
      if (devices.length === 0) {
        const option = document.createElement('option');
        option.textContent = 'Nenhum scanner encontrado';
        select.appendChild(option);
        return;
      }
      
      // Adicionar cada scanner como op√ß√£o (sanitizado)
      devices.forEach(function(device, index) {
        const option = document.createElement('option');
        option.value = index;
        // textContent sanitiza automaticamente (previne XSS)
        option.textContent = device.displayName || device.name || 'Scanner desconhecido';
        select.appendChild(option);
      });
      
      
    }).catch(function(error) {
      console.error('‚ùå Erro ao carregar scanners:', error);
      const select = document.getElementById('scanner-select');
      if (select) {
        select.replaceChildren();
        const option = document.createElement('option');
        option.textContent = 'Erro ao carregar scanners';
        select.appendChild(option);
      }
    });
  }
  
  function carregarImagem() {
    if (!DWTObject) {
      alert('‚ö†Ô∏è Dynamsoft ainda n√£o est√° pronto! Aguarde alguns segundos...');
      return;
    }
    
    DWTObject.IfShowFileDialog = true;
    DWTObject.LoadImageEx('', 5);
  }
  
  // === FUN√á√ÉO PARA ENVIAR PARA AWS (A IMPLEMENTAR) ===
  function enviarParaAWS() {
    if (!DWTObject) {
      alert('‚ö†Ô∏è Dynamsoft ainda n√£o est√° pronto!');
      return;
    }
    
    if (DWTObject.HowManyImagesInBuffer === 0) {
      alert('‚ö†Ô∏è Nenhuma imagem para enviar! Por favor, digitalize primeiro.');
      return;
    }
    
    // TODO: Implementar envio para AWS
    alert('üöß Fun√ß√£o de envio para AWS ser√° implementada em breve!\n\nImagens prontas: ' + DWTObject.HowManyImagesInBuffer);
  }
  
  function digitalizar() {
    if (!DWTObject) {
      alert('‚ö†Ô∏è Dynamsoft ainda n√£o est√° pronto! Aguarde alguns segundos...');
      return;
    }
    
    
    // Pegar o scanner selecionado no select
    var select = document.getElementById('scanner-select');
    if (!select || select.selectedIndex < 0) {
      alert('‚ö†Ô∏è Por favor, selecione um scanner primeiro!');
      return;
    }
    
    var scannerIndex = parseInt(select.value);
    
    // Usar SelectDeviceAsync para selecionar o scanner espec√≠fico SEM popup
    DWTObject.GetDevicesAsync().then(function(devices) {
      if (scannerIndex >= devices.length) {
        throw new Error('Scanner selecionado n√£o encontrado');
      }
      
      var selectedDevice = devices[scannerIndex];
      
      // Selecionar o scanner espec√≠fico (SEM popup)
      return DWTObject.SelectDeviceAsync(selectedDevice);
      
    }).then(function() {
      
      // Configurar timeout
      DWTObject.Timeout = SCANNER_TIMEOUT;
      
      // Capturar imagem com o scanner j√° selecionado
      return DWTObject.AcquireImageAsync({ 
        IfCloseSourceAfterAcquire: true,
        IfShowUI: false,
        IfFeederEnabled: false,
        PixelType: PIXEL_TYPE_COLOR,
        Resolution: DEFAULT_RESOLUTION
      });
      
    }).then(function() {
      // Imagem capturada com sucesso - j√° aparece no viewer
      
    }).catch(function(error) {
      // Verificar se √© timeout mas a imagem foi capturada
      if (error.code === ERROR_CODE_TIMEOUT && DWTObject.HowManyImagesInBuffer > 0) {
        // Timeout mas imagem capturada - ignorar erro silenciosamente
        return;
      }
      
      // Erro real - mostrar para o usu√°rio
      console.error('‚ùå Erro na digitaliza√ß√£o:', error);
      alert('‚ùå Erro: ' + error.message);
    });
  }

  /*----------------------Zoom Methods (Legacy API)---------------------*/
  function btnZoomIn_onclick() {
    if (!DWTObject) {
      console.error('‚ùå DWTObject n√£o dispon√≠vel');
      return;
    }
    
    if (DWTObject.HowManyImagesInBuffer === 0) {
      return;
    }
    
    // Garantir que est√° em single page mode
    DWTObject.Viewer.singlePageMode = true;
    
    var zoomAtual = DWTObject.Viewer.zoom;
    DWTObject.Viewer.zoom = zoomAtual * 1.1; // Aumentar 10%
    
    // For√ßar refresh do viewer
    DWTObject.Viewer.render();
    
    // Atualizar display
    if (document.getElementById("DW_spanZoom")) {
      var displayZoom = Math.round(DWTObject.Viewer.zoom * 100);
      document.getElementById("DW_spanZoom").value = displayZoom + "%";
    }
  }
  
  function btnZoomOut_onclick() {
    if (!DWTObject || DWTObject.HowManyImagesInBuffer === 0) return;
    
    DWTObject.Viewer.singlePageMode = true;
    var zoomAtual = DWTObject.Viewer.zoom;
    DWTObject.Viewer.zoom = zoomAtual * 0.9; // Diminuir 10%
    DWTObject.Viewer.render();
    
    if (document.getElementById("DW_spanZoom")) {
      var displayZoom = Math.round(DWTObject.Viewer.zoom * 100);
      document.getElementById("DW_spanZoom").value = displayZoom + "%";
    }
  }
  
  function btnOrigSize_onclick() {
    if (!DWTObject || DWTObject.HowManyImagesInBuffer === 0) return;
    
    DWTObject.Viewer.singlePageMode = true;
    DWTObject.Viewer.zoom = 1; // 100%
    DWTObject.Viewer.render();
    
    if (document.getElementById("DW_spanZoom")) {
      document.getElementById("DW_spanZoom").value = "100%";
    }
  }
  
  /*----------------------Remove Methods---------------------*/
  function btnRemoveCurrentImage_onclick() {
    if (!DWTObject || DWTObject.HowManyImagesInBuffer === 0) return;
    
    var currentIndex = DWTObject.CurrentImageIndexInBuffer;
    DWTObject.RemoveImage(currentIndex);
  }
  
  function btnRemoveAllImages_onclick() {
    if (!DWTObject || DWTObject.HowManyImagesInBuffer === 0) return;
    
    DWTObject.RemoveAllImages();
  }
  
  /*----------------------Rotate Method---------------------*/
  function btnRotateLeft_onclick() {
    if (!DWTObject || DWTObject.HowManyImagesInBuffer === 0) return;
    
    var currentIndex = DWTObject.CurrentImageIndexInBuffer;
    DWTObject.RotateLeft(currentIndex);
  }
  
  /*----------------------Hand Method (Pan/Drag)---------------------*/
  function btnHand_onclick() {
    if (!DWTObject || DWTObject.HowManyImagesInBuffer === 0) return;
    
    var cursorAtual = DWTObject.Viewer.cursor;
    
    // Alternar entre grab e crosshair
    if (cursorAtual === 'grab' || cursorAtual === 'grabbing') {
      DWTObject.Viewer.cursor = 'crosshair'; // Desativar
    } else {
      DWTObject.Viewer.cursor = 'grab'; // Ativar
    }
  }
  
})(); // Fim do IIFE - M√≥dulo do Scanner
</script>
<script src="{% static 'js/triagem.js' %}"></script>
{% endblock %}


