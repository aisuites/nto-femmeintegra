{% extends "base.html" %}
{% block title %}Recebimento ‚Äì FEMME Integra{% endblock %}
{% block head_extra %}
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --femme-purple: #7a3d8a;
      --femme-purple-soft: #f4e9f8;
      --femme-green: #00bca4;
      --femme-rose-soft: #ffb7c9;

      --femme-white: #ffffff;
      --femme-gray-light: #f5f5f7;
      --femme-gray: #77767c;
      --femme-gray-dark: #34343a;

      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 40px rgba(20, 5, 36, 0.08);
      --shadow-subtle: 0 10px 24px rgba(20, 5, 36, 0.05);

      --max-width: 1280px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Quicksand", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(122, 61, 138, 0.08), transparent 55%),
        radial-gradient(circle at bottom right, rgba(0, 188, 164, 0.06), transparent 55%);
      color: var(--femme-gray-dark);
      line-height: 1.5;
    }

    img {
      max-width: 100%;
      display: block;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      font-family: inherit;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(16px);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(244, 233, 248, 0.9);
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffb7c9 0, #7a3d8a 45%, #4c1f63 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--femme-white);
      font-weight: 700;
      font-size: 18px;
      box-shadow: var(--shadow-subtle);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .brand-text .name {
      font-weight: 700;
      color: var(--femme-purple);
      letter-spacing: 0.03em;
      font-size: 15px;
      text-transform: uppercase;
    }

    .brand-text .tagline {
      font-size: 11px;
      color: var(--femme-gray);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 12px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(244, 233, 248, 0.9);
      color: var(--femme-purple);
      font-weight: 500;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: linear-gradient(135deg, #7a3d8a, #00bca4);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .header-badge-env {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0, 188, 164, 0.08);
      color: var(--femme-green);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* LAYOUT PRINCIPAL */
    .shell {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 18px 20px 32px;
      flex: 1;
      display: grid;
      grid-template-columns: 240px minmax(0, 1fr);
      gap: 20px;
      align-items: flex-start;
    }

    /* SIDEBAR */
    .sidebar {
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-subtle);
      padding: 16px 14px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--femme-gray);
      margin-bottom: 4px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 9px;
      border-radius: 999px;
      color: var(--femme-gray-dark);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .sidebar-link span.icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: rgba(122, 61, 138, 0.04);
      color: var(--femme-purple);
    }

    .sidebar-link:hover {
      background: rgba(244, 233, 248, 0.9);
      transform: translateY(-1px);
    }

    .sidebar-link.active {
      background: linear-gradient(90deg, rgba(122, 61, 138, 0.12), rgba(0, 188, 164, 0.12));
      font-weight: 600;
      color: var(--femme-purple);
    }

    .sidebar-link.subitem {
      padding-left: 28px;
      font-size: 12px;
    }

    .sidebar-link.subitem span.icon {
      font-size: 11px;
      width: 18px;
      height: 18px;
      background: rgba(122, 61, 138, 0.03);
    }

    .sidebar-divider {
      height: 1px;
      background: rgba(230, 224, 238, 0.85);
      margin-block: 6px;
    }

    /* BOT√ïES */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--femme-green);
      color: var(--femme-white);
      box-shadow: 0 10px 22px rgba(0, 188, 164, 0.35);
    }

    .btn-primary:hover {
      background: #00a08c;
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0, 188, 164, 0.4);
    }

    .btn-outline {
      background: transparent;
      color: var(--femme-purple);
      border: 1px solid rgba(122, 61, 138, 0.45);
    }

    .btn-outline:hover {
      background: rgba(244, 233, 248, 0.9);
    }

    .btn-ghost {
      background: transparent;
      color: var(--femme-gray);
      border: none;
      padding-inline: 10px;
    }

    .btn-ghost:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    /* CONTE√öDO PRINCIPAL */
    .main {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* RECEBIMENTO WRAPPER */
    .recebimento-wrapper {
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-subtle);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-kicker {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--femme-gray);
    }

    .section-title {
      font-size: 16px;
      color: var(--femme-purple);
      font-weight: 600;
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--femme-gray);
    }

    .recebimento-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-block {
      border-radius: var(--radius-md);
      background: var(--femme-gray-light);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 12px;
    }

    .block-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--femme-gray);
      font-weight: 600;
    }

    /* UNIDADES ‚Äì COMO BOT√ïES */
    .units-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .units-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .unit-card {
      position: relative;
      border-radius: 999px;
      background: #ffffff;
      padding: 9px 12px;
      border: 1px solid rgba(122, 61, 138, 0.16);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: border 0.15s ease, box-shadow 0.15s ease, transform 0.12s ease, background 0.15s ease, color 0.15s ease;
      font-size: 12px;
      font-weight: 600;
      color: var(--femme-purple);
      text-align: center;
    }

    .unit-card:hover {
      box-shadow: 0 10px 22px rgba(20, 5, 36, 0.06);
      transform: translateY(-1px);
      background: rgba(244, 233, 248, 0.5);
    }

    .unit-card input[type="radio"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }



    .unit-card--selected {
      border-color: var(--femme-purple);
      background: linear-gradient(135deg, rgba(244, 233, 248, 0.95), rgba(255, 255, 255, 1));
      box-shadow: 0 12px 26px rgba(20, 5, 36, 0.12);
    }

    .unit-card--selected .unit-pill {
      border-color: var(--femme-purple);
      background: radial-gradient(circle at center, var(--femme-purple) 0, var(--femme-purple) 40%, #fff 41%);
    }

    /* CAMPOS GERAIS */
    .fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
    }

    @media (max-width: 1024px) {
      .fields-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }

    @media (max-width: 720px) {
      .fields-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
      min-width: 0;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
    }

    label {
      font-weight: 500;
      color: var(--femme-gray-dark);
      font-size: 12px;
    }

    input[type="text"],
    input[type="number"],
    select {
      border-radius: 999px;
      border: 1px solid rgba(122, 61, 138, 0.18);
      background: #ffffff;
      padding: 8px 10px;
      font-size: 12px;
      font-family: inherit;
      color: var(--femme-gray-dark);
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      width: 100%;
      min-width: 0;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    input:focus,
    select:focus {
      border-color: var(--femme-purple);
      box-shadow: 0 0 0 1px rgba(122, 61, 138, 0.2);
    }

    input[readonly] {
      background: #f4f2f7;
      border-style: dashed;
      color: var(--femme-gray);
    }

    input[type="number"] {
      appearance: textfield;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* CONTROLE DE QUANTIDADE */
    .qty-control {
      display: grid;
      grid-template-columns: auto minmax(40px, 1fr) auto;
      align-items: center;
      gap: 4px;
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid rgba(122, 61, 138, 0.18);
      padding: 0 4px;
    }

    .qty-input {
      border: none;
      text-align: center;
      padding: 7px 4px;
      font-size: 12px;
      width: 100%;
      background: transparent;
    }

    .qty-input:focus {
      outline: none;
      box-shadow: none;
    }

    .qty-btn {
      border: none;
      background: transparent;
      width: 28px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      color: var(--femme-purple);
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .qty-btn:hover {
      background: rgba(244, 233, 248, 0.9);
      transform: translateY(-1px);
    }

    /* BARRA DE C√ìDIGO */
    .barcode-row {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) auto;
      gap: 8px;
      align-items: center;
    }

    .info-inline {
      font-size: 11px;
      color: var(--femme-gray);
      margin-top: 4px;
    }

    .alert {
      display: none;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(255, 119, 119, 0.1);
      color: #b20000;
      border: 1px solid rgba(255, 119, 119, 0.3);
      align-items: center;
      gap: 8px;
    }

    .alert--visible {
      display: flex;
    }

    .alert strong {
      font-size: 13px;
    }

    /* TOAST DE SUCESSO */
    .toast-success {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
      font-size: 14px;
      font-weight: 600;
      z-index: 9999;
      display: none;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
    }

    .toast-success.show {
      display: flex;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 6, 22, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-overlay[aria-hidden="false"] {
      display: flex;
    }

    .modal {
      width: min(520px, 100% - 32px);
      background: #ffffff;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 16px;
      font-family: "Quicksand", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--femme-gray-dark);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .modal-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-badge-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: var(--femme-purple-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--femme-purple);
      font-size: 16px;
    }

    .modal-title-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-title-text span.label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--femme-gray);
    }

    .modal-title-text h2 {
      font-size: 15px;
      color: var(--femme-purple);
      font-weight: 600;
    }

    .modal-close-icon {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      color: var(--femme-gray);
    }

    .modal-body {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-main-text {
      padding: 10px 10px;
      border-radius: var(--radius-md);
      background: var(--femme-gray-light);
      font-weight: 600;
      color: var(--femme-gray-dark);
      text-transform: uppercase;
      font-size: 11px;
    }

    .modal-meta {
      font-size: 11px;
      color: var(--femme-gray);
    }

    .modal-meta strong {
      color: var(--femme-purple);
    }

    .samples-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .sample-line {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      gap: 6px;
      align-items: center;
    }

    .sample-line span.index {
      font-size: 11px;
      color: var(--femme-gray);
      padding: 4px 8px;
      border-radius: 999px;
      background: #f7f4fb;
    }

    .sample-line input[type="text"] {
      border-radius: 999px;
      border: 1px solid rgba(122, 61, 138, 0.18);
      background: #ffffff;
      padding: 7px 10px;
      font-size: 12px;
      font-family: inherit;
      color: var(--femme-gray-dark);
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }

    .sample-line input[type="text"]:focus {
      border-color: var(--femme-purple);
      box-shadow: 0 0 0 1px rgba(122, 61, 138, 0.2);
    }

    .modal-footer {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 12px;
    }

    /* TABELA DE REQUISI√á√ïES BIPADAS */
    .kit-table-wrapper {
      border-radius: var(--radius-md);
      background: #ffffff;
      box-shadow: 0 6px 14px rgba(20, 5, 36, 0.05);
      overflow: hidden;
    }

    .kit-table-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(230, 224, 238, 0.85);
      font-size: 12px;
      color: var(--femme-gray);
    }

    .kit-table-header strong {
      color: var(--femme-gray-dark);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: var(--femme-purple-soft);
    }

    th,
    td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(240, 235, 245, 0.9);
    }

    th {
      font-weight: 600;
      color: var(--femme-gray-dark);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:nth-child(even) {
      background: #fcfbfe;
    }

    .table-actions {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(122, 61, 138, 0.25);
      font-size: 11px;
      cursor: pointer;
      background: #fff;
    }

    .chip:hover {
      background: var(--femme-purple-soft);
    }

    /* RESPONSIVO GERAL */
    @media (max-width: 1024px) {
      .shell {
        grid-template-columns: minmax(0, 1fr);
      }

      .sidebar {
        order: -1;
        flex-direction: row;
        flex-wrap: wrap;
      }

      .sidebar-section-title {
        flex-basis: 100%;
      }

      .kit-table-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 720px) {
      .header-inner {
        padding-inline: 14px;
      }

      .shell {
        padding-inline: 14px;
      }

      table {
        font-size: 11px;
      }

      th,
      td {
        padding: 6px 8px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="page">

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo">F</div>
        <div class="brand-text">
          <div class="name">FEMME Integra</div>
          <div class="tagline">Gest√£o de requisi√ß√µes & amostras</div>
        </div>
      </div>

      <div class="header-right">
        <span class="header-badge-env">Ambiente interno</span>
        <div class="user-info">
          <div class="user-avatar">L</div>
          <div>
            <div style="font-weight:600;">Luciana</div>
            <div style="font-size:11px; color:var(--femme-gray);">Marketing / Projetos FEMME</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- LAYOUT PRINCIPAL -->
  <div class="shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="sidebar-section-title">Navega√ß√£o</div>
        <nav class="sidebar-nav">
          <a class="sidebar-link {% if active_page == 'dashboard' %}active{% endif %}" href="{% url 'core:dashboard' %}">
            <span class="icon">üè†</span>
            <span>Dashboard</span>
          </a>
          <div class="sidebar-link">
            <span class="icon">‚öô</span>
            <span>Operacional</span>
          </div>
          <a class="sidebar-link subitem {% if active_page == 'recebimento' %}active{% endif %}" href="{% url 'operacao:recebimento' %}">
            <span class="icon">‚¨á</span>
            <span>Recebimento</span>
          </a>
          <div class="sidebar-link subitem">
            <span class="icon">ü©∫</span>
            <span>Triagem</span>
          </div>
          <div class="sidebar-link subitem">
            <span class="icon">‚è±</span>
            <span>Pend√™ncias</span>
          </div>

          <div class="sidebar-divider"></div>

          <div class="sidebar-link">
            <span class="icon">üìä</span>
            <span>Gest√£o</span>
          </div>

          <div class="sidebar-link">
            <span class="icon">üí¨</span>
            <span>Atendimento</span>
          </div>
        </nav>
      </div>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main">

      <!-- BLOCO PRINCIPAL: FORM DE RECEBIMENTO -->
      <section class="recebimento-wrapper">
        <div class="recebimento-header">
          <div class="section-kicker">Recebimento</div>
          <!--<div class="section-title">Registrar novo kit de requisi√ß√µes</div>-->
          <!--<div class="section-subtitle">
            Informe a unidade de origem, portador/representante, quantidade de amostras e bipagem
            da requisi√ß√£o principal. As requisi√ß√µes bipadas ser√£o listadas abaixo.
          </div>-->
        </div>

        <!-- BLOCO 1 ‚Äì UNIDADE -->
        <div class="form-block">
          <div class="block-title">1. Unidade</div>
          <div class="units-grid">
            {% if unidades %}
              {% for unidade in unidades %}
                <label class="unit-card {% if unidade_padrao and unidade.id == unidade_padrao.id %}unit-card--selected{% endif %}">
                  <input
                      type="radio"
                      name="unidade_origem"
                      value="{{ unidade.id }}"
                      data-unidade-nome="{{ unidade.nome }}"
                      data-unidade-codigo="{{ unidade.codigo }}"
                      {% if unidade_padrao and unidade.id == unidade_padrao.id %}checked{% endif %}
                  />
                  <span>{{ unidade.nome }}</span>
                </label>
              {% endfor %}
            {% else %}
              <p class="info-inline">Cadastre unidades para habilitar esta etapa.</p>
            {% endif %}
          </div>
          <input type="hidden" id="unidadeSelecionada" name="unidade_id" value="{{ unidade_padrao.id|default_if_none:'' }}">
        </div>

        <!-- BLOCO 2 ‚Äì PORTADOR / REPRESENTANTE E ORIGEM -->
        <div class="form-block">
          <div class="block-title">2. Portador / Representante & origem</div>

          <div class="fields-grid">
            <div class="field">
              <div class="field-label-row">
                <label for="campo_portador">Portador / Representante</label>
              </div>
              <!-- No Django este select vir√° da tabela de portadores/representantes -->
              <select id="campo_portador">
                <option value="">Selecione...</option>
                {% for portador in portadores %}
                  <option
                      value="{{ portador.id }}"
                      data-unidade-id="{{ portador.unidade_id }}"
                      data-origem="{{ portador.origem.descricao|default_if_none:'' }}"
                      data-tipo="{{ portador.get_tipo_display }}"
                  >
                    {{ portador.nome }}
                  </option>
                {% empty %}
                  <option value="" disabled>Nenhum portador cadastrado</option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <div class="field-label-row">
                <label for="campo_origem">Origem</label>
              </div>
              <input type="text" id="campo_origem" readonly
                     placeholder="Ser√° preenchido automaticamente" />
            </div>

            <div class="field">
              <div class="field-label-row">
                <label for="campo_qtd_amostras">Qtd. de amostras</label>
              </div>
              <div class="qty-control">
                <button class="qty-btn" type="button" id="btn_qty_menos">‚àí</button>
                <input class="qty-input" id="campo_qtd_amostras" type="number" min="1" value="1" />
                <button class="qty-btn" type="button" id="btn_qty_mais">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- BLOCO 3 ‚Äì BIPAGEM DA REQUISI√á√ÉO -->
        <div class="form-block">
          <div class="block-title">3. Bipagem da requisi√ß√£o</div>

          <div class="field">
            <div class="field-label-row">
              <label for="campo_cod_barras">C√≥digo de barras da requisi√ß√£o</label>
            </div>

            <div class="barcode-row">
              <div style="position:absolute; width:0; height:0; overflow:hidden;" aria-hidden="true">
                <input type="hidden" id="csrf_token_input" value="{{ csrf_token }}">
                {% csrf_token %}
              </div>
              <input type="text" id="campo_cod_barras" placeholder="Aproxime a pistola ou digite o c√≥digo" />
              <button class="btn btn-primary" type="button" id="btn_localizar" data-url="{% url 'operacao:recebimento-localizar' %}">
                üîç Localizar
              </button>
            </div>

            <div class="info-inline">
              ‚Ä¢ A pistola de c√≥digo de barras deve disparar automaticamente a a√ß√£o de localizar.
              Se necess√°rio, o usu√°rio pode digitar o c√≥digo manualmente e clicar em <strong>Localizar</strong>.
            </div>

            <div class="alert" id="recebimento_alert" role="alert" aria-live="assertive">
              <strong>Ops!</strong>
              <span id="alert_message"></span>
            </div>
          </div>
        </div>

        <!-- LISTA DE REQUISI√á√ïES BIPADAS -->
        <div class="kit-table-wrapper">
          <div class="kit-table-header">
            <div>
              <strong>Requisi√ß√µes bipadas neste kit:</strong> {{ requisicoes_recent|length }} registros
            </div>
            <div>
              Kit em edi√ß√£o ¬∑ n√£o esque√ßa de salvar ao finalizar
            </div>
          </div>

          {% if requisicoes_recent %}
            <table>
              <thead>
              <tr>
                <th>C√≥d. Req.</th>
                <th>C√≥d. Barras</th>
                <th>Unidade</th>
                <th>Origem</th>
                <th>Data/Hora bipagem</th>
              </tr>
              </thead>
              <tbody>
              {% for requisicao in requisicoes_recent %}
                <tr>
                  <td>{{ requisicao.cod_req }}</td>
                  <td>{{ requisicao.cod_barras_req }}</td>
                  <td>{{ requisicao.unidade.nome }}</td>
                  <td>{{ requisicao.origem.descricao|default:"-" }}</td>
                  <td>{{ requisicao.created_at|date:"d/m/Y ¬∑ H:i" }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div style="padding:16px; font-size:12px; color:var(--femme-gray);">
              Ainda n√£o h√° requisi√ß√µes bipadas. Utilize o formul√°rio acima para iniciar um kit.
            </div>
          {% endif %}
        </div>

        <!-- A√á√ïES FINAIS DO KIT -->
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:6px; font-size:12px;">
          <button class="btn btn-ghost" type="button">Cancelar kit</button>
          <button class="btn btn-outline" type="button">Salvar rascunho</button>
          <button class="btn btn-primary" type="button" id="btn_finalizar_recebimento">‚úÖ Finalizar recebimento</button>
        </div>
      </section>
    </main>
    <!-- MODAL BIPAGEM -->
    <div class="modal-overlay" id="modal_bipagem" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal_title">
        <div class="modal-header">
          <div class="modal-title" id="modal_title">
            <div class="modal-badge-icon">‚ö†</div>
            <div class="modal-title-text">
              <span class="label">Aviso de recebimento</span>
              <h2>Bipagem das amostras do kit</h2>
            </div>
          </div>
          <button class="modal-close-icon" type="button" id="modal_close" aria-label="Fechar modal">√ó</button>
        </div>

        <div class="modal-body">
          <div class="modal-main-text">
            PARA DAR ANDAMENTO BIPE O(S) C√ìDIGO(S) DE BARRA(S) DA(S) AMOSTRA(S).
          </div>

          <div class="modal-meta">
            Requisi√ß√£o: <strong id="modal_cod_req">‚Äî</strong> ¬∑
            C√≥digo de barras da requisi√ß√£o: <strong id="modal_cod_barras_req">‚Äî</strong><br />
            Qtd. de amostras informada: <strong id="modal_qtd_amostras">0</strong>
            &nbsp;‚Äì&nbsp; bipar o mesmo n√∫mero de c√≥digos abaixo.
          </div>

          <div class="field">
            <div class="field-label-row">
              <label>C√≥digos de barras das amostras</label>
              <span class="helper">Um c√≥digo por amostra</span>
            </div>

            <div class="samples-list" id="modal_samples_list"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline" type="button" id="modal_btn_cancelar">Cancelar</button>
          <button class="btn btn-primary" type="button" id="modal_btn_validar">Validar</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const hiddenField = document.getElementById('unidadeSelecionada');
    const radioInputs = document.querySelectorAll('.unit-card input[type="radio"]');
    const portadorSelect = document.getElementById('campo_portador');
    const origemInput = document.getElementById('campo_origem');
    const quantidadeInput = document.getElementById('campo_qtd_amostras');
    const barcodeInput = document.getElementById('campo_cod_barras');
    const localizarBtn = document.getElementById('btn_localizar');
    const alertaBox = document.getElementById('recebimento_alert');
    const alertaMsg = document.getElementById('alert_message');
    const modalOverlay = document.getElementById('modal_bipagem');
    const modalClose = document.getElementById('modal_close');
    const modalCancelar = document.getElementById('modal_btn_cancelar');
    const modalValidar = document.getElementById('modal_btn_validar');
    const modalQtd = document.getElementById('modal_qtd_amostras');
    const modalCodBarras = document.getElementById('modal_cod_barras_req');
    const modalCodReq = document.getElementById('modal_cod_req');
    const modalSamplesList = document.getElementById('modal_samples_list');
    const portadoresData = JSON.parse('{{ portadores_json|escapejs }}');

    function getCookie(name) {
      const cookieValue = document.cookie
        .split(';')
        .map(cookie => cookie.trim())
        .find(cookie => cookie.startsWith(`${name}=`));
      if (cookieValue) {
        return decodeURIComponent(cookieValue.split('=')[1]);
      }
      return null;
    }

    const csrfToken = getCookie('csrftoken');
    const btnQtyMenos = document.getElementById('btn_qty_menos');
    const btnQtyMais = document.getElementById('btn_qty_mais');
    const btnFinalizarRecebimento = document.getElementById('btn_finalizar_recebimento');

    // Controle de quantidade de amostras
    btnQtyMenos?.addEventListener('click', () => {
      if (!quantidadeInput) return;
      const atual = parseInt(quantidadeInput.value, 10) || 1;
      if (atual > 1) {
        quantidadeInput.value = atual - 1;
      }
    });

    btnQtyMais?.addEventListener('click', () => {
      if (!quantidadeInput) return;
      const atual = parseInt(quantidadeInput.value, 10) || 1;
      quantidadeInput.value = atual + 1;
    });

    // Garantir valor m√≠nimo ao digitar manualmente
    quantidadeInput?.addEventListener('change', () => {
      const valor = parseInt(quantidadeInput.value, 10);
      if (isNaN(valor) || valor < 1) {
        quantidadeInput.value = 1;
      }
    });

    function updateSelectedState(selectedInput) {
      document.querySelectorAll('.unit-card').forEach(card => card.classList.remove('unit-card--selected'));
      const parentCard = selectedInput.closest('.unit-card');
      if (parentCard) {
        parentCard.classList.add('unit-card--selected');
      }
      if (hiddenField) {
        hiddenField.value = selectedInput.value;
      }
      filtrarPortadores(Number(selectedInput.value));
    }

    function atualizarOrigemFromSelect() {
      const selectedOption = portadorSelect?.options[portadorSelect.selectedIndex];
      if (origemInput) {
        origemInput.value = selectedOption?.dataset?.origem || '';
      }
    }

    function filtrarPortadores(unidadeId) {
      if (!portadorSelect) return;

      portadorSelect.innerHTML = '<option value=\"\">Selecione...</option>';

      const filtrados = portadoresData.filter(item => item.unidade_id === unidadeId);
      if (!filtrados.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.disabled = true;
        opt.textContent = 'Nenhum portador dispon√≠vel para a unidade';
        portadorSelect.appendChild(opt);
        portadorSelect.value = '';
        if (origemInput) origemInput.value = '';
        return;
      }

      filtrados.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.dataset.unidadeId = item.unidade_id;
        opt.dataset.origem = item.origem;
        opt.dataset.origemId = item.origem_id;
        opt.dataset.tipo = item.tipo;
        opt.textContent = `${item.nome} (${item.tipo})`;
        portadorSelect.appendChild(opt);
      });
      portadorSelect.value = '';
      if (origemInput) origemInput.value = '';
    }

    portadorSelect?.addEventListener('change', atualizarOrigemFromSelect);

    function mostrarAlerta(mensagem) {
      if (!alertaBox || !alertaMsg) return;
      alertaMsg.textContent = mensagem;
      alertaBox.classList.add('alert--visible');
    }

    function esconderAlerta() {
      if (!alertaBox) return;
      alertaBox.classList.remove('alert--visible');
      alertaMsg.textContent = '';
    }

    function validarPreCondicoes() {
      if (!hiddenField?.value) {
        return { ok: false, message: 'Selecione uma unidade antes de localizar.' };
      }
      if (!portadorSelect?.value) {
        return { ok: false, message: 'Escolha um portador/representante.' };
      }
      const quantidade = Number(quantidadeInput?.value || 0);
      if (!quantidade || quantidade < 1) {
        return { ok: false, message: 'Informe uma quantidade v√°lida de amostras.' };
      }
      const codigo = (barcodeInput?.value || '').trim();
      if (!codigo) {
        return { ok: false, message: 'Digite ou bipe o c√≥digo de barras da requisi√ß√£o.' };
      }

      return { ok: true, quantidade, codigo };
    }

    function construirLinhasAmostra(qtd) {
      if (!modalSamplesList) return;
      modalSamplesList.innerHTML = '';
      for (let idx = 1; idx <= qtd; idx += 1) {
        const linha = document.createElement('div');
        linha.className = 'sample-line';

        const legenda = document.createElement('span');
        legenda.className = 'index';
        legenda.textContent = `Amostra ${idx}`;

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `Bipe ou digite o c√≥digo da amostra ${idx}`;
        input.autocomplete = 'off';

        linha.appendChild(legenda);
        linha.appendChild(input);
        modalSamplesList.appendChild(linha);
      }
    }

    function abrirModal(quantidade, codigoBarras) {
      if (!modalOverlay) return;
      modalQtd.textContent = quantidade;
      modalCodBarras.textContent = codigoBarras;
      modalCodReq.textContent = '‚Äî';
      construirLinhasAmostra(quantidade);
      modalOverlay.setAttribute('aria-hidden', 'false');
    }

    function fecharModal() {
      if (!modalOverlay) return;
      modalOverlay.setAttribute('aria-hidden', 'true');
    }

    async function localizarCodigo() {
      const validacao = validarPreCondicoes();
      if (!validacao.ok) {
        mostrarAlerta(validacao.message);
        return;
      }

      esconderAlerta();
      const url = localizarBtn?.dataset?.url;
      if (!url) {
        mostrarAlerta('Endpoint de localiza√ß√£o n√£o configurado.');
        return;
      }

      localizarBtn?.setAttribute('aria-busy', 'true');
      localizarBtn?.setAttribute('disabled', 'disabled');

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({
            cod_barras: validacao.codigo,
          }),
        });

        const data = await response.json();
        if (!response.ok || data.status === 'error') {
          mostrarAlerta(data.message || 'Falha ao localizar o c√≥digo.');
          return;
        }

        if (data.status === 'found') {
          mostrarAlerta('J√° existe registro para este c√≥digo de barras.');
          return;
        }

        if (data.status === 'not_found') {
          abrirModal(validacao.quantidade, validacao.codigo);
          return;
        }

        mostrarAlerta('Retorno inesperado do servidor.');
      } catch (error) {
        console.error(error);
        mostrarAlerta('Erro de comunica√ß√£o com o servidor. Tente novamente.');
      } finally {
        localizarBtn?.removeAttribute('aria-busy');
        localizarBtn?.removeAttribute('disabled');
      }
    }

    localizarBtn?.addEventListener('click', localizarCodigo);
    barcodeInput?.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        localizarCodigo();
      }
    });

    modalClose?.addEventListener('click', fecharModal);
    modalCancelar?.addEventListener('click', fecharModal);
    modalOverlay?.addEventListener('click', (event) => {
      if (event.target === modalOverlay) {
        fecharModal();
      }
    });

    // Bot√£o Finalizar Recebimento - limpa sessionStorage
    btnFinalizarRecebimento?.addEventListener('click', () => {
      sessionStorage.removeItem('recebimento_unidade_id');
      sessionStorage.removeItem('recebimento_portador_id');
      mostrarToastSucesso('Recebimento finalizado! Valores resetados.');
      setTimeout(() => {
        location.reload();
      }, 1500);
    });

    modalValidar?.addEventListener('click', async () => {
      esconderAlerta();
      
      // Coletar c√≥digos de barras das amostras
      const inputsAmostras = modalSamplesList?.querySelectorAll('input[type="text"]') || [];
      const codigosAmostras = [];
      
      for (const input of inputsAmostras) {
        const valor = (input.value || '').trim();
        if (!valor) {
          mostrarAlerta('Todos os campos de c√≥digo de barras das amostras devem ser preenchidos.');
          return;
        }
        codigosAmostras.push(valor);
      }

      const codBarrasReq = modalCodBarras?.textContent?.trim() || '';
      const unidadeId = hiddenField?.value;
      const portadorId = portadorSelect?.value;
      const origemId = portadorSelect?.options[portadorSelect.selectedIndex]?.dataset?.origemId;

      if (!unidadeId || !portadorId) {
        mostrarAlerta('Dados incompletos para valida√ß√£o.');
        return;
      }

      const urlValidar = '{% url "operacao:recebimento-validar" %}';
      modalValidar?.setAttribute('aria-busy', 'true');
      modalValidar?.setAttribute('disabled', 'disabled');

      try {
        const response = await fetch(urlValidar, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({
            cod_barras_req: codBarrasReq,
            cod_barras_amostras: codigosAmostras,
            unidade_id: unidadeId,
            portador_id: portadorId,
            origem_id: origemId,
          }),
        });

        const data = await response.json();
        if (!response.ok || data.status === 'error') {
          mostrarAlerta(data.message || 'Erro ao validar requisi√ß√£o.');
          return;
        }

        if (data.status === 'success') {
          // Mostrar toast de sucesso
          mostrarToastSucesso(`Requisi√ß√£o ${data.cod_req} criada com sucesso!`);
          
          // Fechar modal
          fecharModal();
          
          // Limpar apenas o campo de c√≥digo de barras e resetar quantidade
          if (barcodeInput) barcodeInput.value = '';
          if (quantidadeInput) quantidadeInput.value = 1;
          
          // Salvar valores atuais no sessionStorage
          sessionStorage.setItem('recebimento_unidade_id', hiddenField?.value || '');
          sessionStorage.setItem('recebimento_portador_id', portadorSelect?.value || '');
          
          // Recarregar ap√≥s 2.5 segundos
          setTimeout(() => {
            location.reload();
          }, 2500);
        }
      } catch (error) {
        console.error(error);
        mostrarAlerta('Erro de comunica√ß√£o com o servidor.');
      } finally {
        modalValidar?.removeAttribute('aria-busy');
        modalValidar?.removeAttribute('disabled');
      }
    });

    radioInputs.forEach(input => {
      input.addEventListener('change', () => updateSelectedState(input));
      input.addEventListener('click', () => updateSelectedState(input));
    });

    // Fun√ß√£o para mostrar toast de sucesso
    function mostrarToastSucesso(mensagem) {
      let toast = document.getElementById('toast_sucesso');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast_sucesso';
        toast.className = 'toast-success';
        document.body.appendChild(toast);
      }
      toast.textContent = mensagem;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    // Restaurar valores do sessionStorage
    const savedUnidadeId = sessionStorage.getItem('recebimento_unidade_id');
    const savedPortadorId = sessionStorage.getItem('recebimento_portador_id');
    
    if (savedUnidadeId) {
      const radioToCheck = document.querySelector(`.unit-card input[type="radio"][value="${savedUnidadeId}"]`);
      if (radioToCheck) {
        radioToCheck.checked = true;
        updateSelectedState(radioToCheck);
        
        // Restaurar portador ap√≥s filtrar
        if (savedPortadorId) {
          setTimeout(() => {
            if (portadorSelect) {
              portadorSelect.value = savedPortadorId;
              atualizarOrigemFromSelect();
            }
          }, 100);
        }
      }
    } else {
      // Comportamento padr√£o se n√£o houver valores salvos
      const initiallyChecked = document.querySelector('.unit-card input[type="radio"]:checked');
      if (initiallyChecked) {
        updateSelectedState(initiallyChecked);
      } else if (radioInputs.length) {
        updateSelectedState(radioInputs[0]);
      }
    }
  });
</script>
{% endblock %}
